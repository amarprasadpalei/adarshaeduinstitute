<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adarsha Educational Institute</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        /* Base Styling & Theme Variables */
        :root {
            --background: #f0f2f5;
            --foreground: #ffffff;
            --sidebar: #1e293b;
            --sidebar-foreground: #cbd5e1;
            --sidebar-hover: #334155;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --input: #f1f5f9;
        }

        .dark {
            --background: #0f172a;
            --foreground: #1e293b;
            --sidebar: #020617;
            --sidebar-foreground: #94a3b8;
            --sidebar-hover: #1e293b;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --input: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--background); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Ripple Effect for Buttons */
        .ripple {
            background-position: center;
            transition: background 0.8s;
        }
        .ripple:hover {
            background: var(--primary-hover) radial-gradient(circle, transparent 1%, var(--primary-hover) 1%) center/15000%;
        }
        .ripple:active {
            background-color: var(--primary);
            background-size: 100%;
            transition: background 0s;
        }

        /* Custom Styles for App Elements */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: var(--sidebar);
            color: var(--sidebar-foreground);
            transition: width 0.3s ease-in-out;
            flex-shrink: 0;
        }
        
        .sidebar.collapsed {
            width: 72px;
        }
        
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--background);
        }

        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-link:hover, .sidebar-link.active {
            background-color: var(--sidebar-hover);
            color: white;
        }
        
        .sidebar.collapsed .sidebar-link span, .sidebar.collapsed .sidebar-link .badge {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-logo .logo-text {
            display: none;
        }
        .sidebar.collapsed .sidebar-footer .user-name, .sidebar.collapsed .sidebar-footer .user-role {
             display: none;
        }
        .sidebar.collapsed .sidebar-footer {
            justify-content: center;
        }

        /* General Card/Panel Styling */
        .card {
            background-color: var(--foreground);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .input-field {
            background-color: var(--input);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            color: var(--text-primary);
        }
        
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--foreground);
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 90%;
            animation: fadeIn 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/50 dark:bg-black/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-600"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-[99]">
        <p>This is a toast message!</p>
    </div>

    <!-- MAIN APPLICATION CONTAINER -->
    <div id="app">

        <!-- =================================================================== -->
        <!-- ======================== LOGIN PAGE =============================== -->
        <!-- =================================================================== -->
        <section id="login-page" class="page hidden flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900 fade-in">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                     <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-600"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    <h1 class="text-3xl font-bold text-slate-800 dark:text-white mt-2">Adarsha Educational Institute</h1>
                    <p class="text-slate-500 dark:text-slate-400">Welcome back! Please sign in to your account.</p>
                </div>

                <div class="card bg-white dark:bg-slate-800 p-8">
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                        <button id="admin-login-tab" class="login-tab active flex-1 py-3 text-center font-semibold text-indigo-600 border-b-2 border-indigo-600 transition">Admin</button>
                        <button id="teacher-login-tab" class="login-tab flex-1 py-3 text-center font-semibold text-slate-500 dark:text-slate-400 transition">Teacher</button>
                    </div>

                    <!-- Admin Login Form -->
                    <form id="admin-login-form" class="space-y-4">
                        <input type="email" id="admin-email" placeholder="Admin Email" class="input-field dark:bg-slate-700 dark:border-slate-600" required>
                        <input type="password" id="admin-password" placeholder="Password" class="input-field dark:bg-slate-700 dark:border-slate-600" required>
                        <button type="submit" class="btn-primary w-full ripple">Sign In as Admin</button>
                    </form>

                    <!-- Teacher Login Form -->
                    <form id="teacher-login-form" class="space-y-4 hidden">
                        <input type="email" id="teacher-email" placeholder="Teacher Email" class="input-field dark:bg-slate-700 dark:border-slate-600" required>
                        <input type="password" id="teacher-password" placeholder="Password" class="input-field dark:bg-slate-700 dark:border-slate-600" required>
                        <button type="submit" class="btn-primary w-full ripple">Sign In as Teacher</button>
                    </form>
                </div>
                 <p class="text-center text-sm text-slate-500 mt-6">
                    Looking for the student portal? <a href="#student-portal" id="go-to-student-portal" class="font-semibold text-indigo-600 hover:underline">Click here</a>.
                </p>
            </div>
        </section>

        <!-- =================================================================== -->
        <!-- ====================== DASHBOARD CONTAINER ======================== -->
        <!-- =================================================================== -->
        <div id="dashboard-container" class="app-container hidden">
            <!-- Sidebar is dynamically inserted here -->
            
            <!-- Main Content Area -->
            <main class="main-content">
                <header class="p-4 md:p-6 bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm sticky top-0 z-10 flex items-center justify-between border-b border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-4">
                        <button id="sidebar-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 md:hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        <h1 id="page-title" class="text-xl md:text-2xl font-bold">Dashboard</h1>
                    </div>
                    <div class="flex items-center gap-4">
                         <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                            <!-- Sun and Moon icons will be toggled here -->
                        </button>
                        <button id="header-logout-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" title="Logout">
                            <i data-lucide="LogOut" class="w-5 h-5 text-slate-600 dark:text-slate-400"></i>
                        </button>
                        <div class="w-10 h-10 rounded-full bg-indigo-200 dark:bg-indigo-900 flex items-center justify-center font-bold text-indigo-700 dark:text-indigo-300 border-2 border-indigo-400" id="user-avatar">
                            A
                        </div>
                    </div>
                </header>
                
                <div class="p-4 md:p-6 space-y-6">
                    <!-- =================================================================== -->
                    <!-- ======================= ADMIN DASHBOARD ========================= -->
                    <!-- =================================================================== -->
                    <section id="admin-dashboard" class="dashboard-page hidden space-y-6">
                        <!-- Admin Subsections will be dynamically shown here -->
                    </section>
                    
                    <!-- =================================================================== -->
                    <!-- ======================= TEACHER DASHBOARD ======================= -->
                    <!-- =================================================================== -->
                    <section id="teacher-dashboard" class="dashboard-page hidden space-y-6">
                        <!-- Teacher Subsections will be dynamically shown here -->
                    </section>
                </div>
            </main>
        </div>

        <!-- =================================================================== -->
        <!-- =================== STUDENT & PARENT PORTAL ======================= -->
        <!-- =================================================================== -->
        <section id="student-portal" class="page fade-in">
            <!-- Student Portal content goes here -->
             <header class="bg-indigo-600 text-white shadow-md">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                            <span class="ml-3 text-2xl font-bold">Adarsha Educational Institute</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <a href="#login-page" id="go-to-login" class="px-4 py-2 text-sm font-medium bg-white text-indigo-600 rounded-md hover:bg-indigo-50 transition">Admin/Teacher Login</a>
                             <button id="student-theme-toggle" class="p-2 rounded-full hover:bg-white/20">
                                <!-- Icons here -->
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <main class="container mx-auto p-4 sm:p-6 lg:p-8">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Notices Card -->
                    <div class="lg:col-span-2 card">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="Megaphone" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            Notice Board
                        </h2>
                        <div id="student-notices-list" class="space-y-4 max-h-96 overflow-y-auto">
                             <p class="text-slate-500">No notices available at the moment.</p>
                        </div>
                    </div>

                    <!-- Upcoming Exams Card -->
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="CalendarDays" class="w-6 h-6 mr-2 text-amber-500"></i>
                            Upcoming Exams
                        </h2>
                        <div id="student-exams-list" class="space-y-3 max-h-96 overflow-y-auto">
                           <p class="text-slate-500">No upcoming exams scheduled.</p>
                        </div>
                    </div>

                    <!-- Daily Absentees -->
                    <div class="card md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="UserX" class="w-6 h-6 mr-2 text-red-500"></i>
                            Today's Absentee List
                        </h2>
                        <div id="student-absentees-list" class="max-h-[400px] overflow-y-auto">
                           <p class="text-slate-500">Attendance for today has not been marked yet.</p>
                        </div>
                    </div>
                    
                    <!-- Published Attendance Sheets -->
                    <div class="card md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="Sheet" class="w-6 h-6 mr-2 text-sky-500"></i>
                            Published Attendance Sheets
                        </h2>
                        <div class="flex items-center gap-4 mb-4">
                            <select id="attendance-sheet-month" class="input-field w-auto dark:bg-slate-700 dark:border-slate-600">
                                <!-- Months will be populated here -->
                            </select>
                             <select id="attendance-sheet-class" class="input-field w-auto dark:bg-slate-700 dark:border-slate-600">
                                <!-- Classes will be populated here -->
                            </select>
                            <button id="view-attendance-sheet-btn" class="btn-primary ripple">View</button>
                        </div>
                        <div id="student-attendance-sheets-display" class="max-h-[500px] overflow-y-auto">
                           <p class="text-slate-500">Select a month and class to view published attendance sheets.</p>
                        </div>
                    </div>
                    
                     <!-- Published Marks Sheets -->
                    <div class="card md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="GraduationCap" class="w-6 h-6 mr-2 text-green-500"></i>
                           All Published Marks
                        </h2>
                        <div id="student-marks-display" class="max-h-[60vh] overflow-y-auto">
                           <p class="text-slate-500">Loading all published marks...</p>
                        </div>
                    </div>

                </div>
            </main>
        </section>

    </div> <!-- End #app -->

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp, getApps, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            deleteUser,
            reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            addDoc,
            collection,
            onSnapshot,
            query,
            where,
            serverTimestamp,
            writeBatch,
            getDocs,
            deleteDoc,
            orderBy,
            limit,
            updateDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================
        // ====================== FIREBASE CONFIG ============================
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCq4cAvfe2_-y2beX2yiSkSAnSgTWDwhQY",
            authDomain: "aeiwebsiteai.firebaseapp.com",
            databaseURL: "https://aeiwebsiteai-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aeiwebsiteai",
            storageBucket: "aeiwebsiteai.firebasestorage.app",
            messagingSenderId: "238874682793",
            appId: "1:238874682793:web:d9be489483f042b1c950b8"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        const state = {
            currentUser: null,
            userRole: null,
            activePage: 'student-portal', // Default to student portal
            unsubscribeListeners: [],
            allClasses: [],
            allExams: [],
            allStudents: [],
            currentTeacherData: null,
            marksChart: null,
        };

        // DOM Elements
        const DOMElements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            toast: document.getElementById('toast-notification'),
            pages: document.querySelectorAll('.page'),
            dashboardContainer: document.getElementById('dashboard-container'),
            loginPage: document.getElementById('login-page'),
            adminDashboard: document.getElementById('admin-dashboard'),
            teacherDashboard: document.getElementById('teacher-dashboard'),
            studentPortal: document.getElementById('student-portal'),
            pageTitle: document.getElementById('page-title'),
            modalContainer: document.getElementById('modal-container'),
        };

        // ===================================================================
        // ===================== UTILITY FUNCTIONS ===========================
        // ===================================================================

        const showLoading = () => DOMElements.loadingSpinner.classList.remove('hidden');
        const hideLoading = () => DOMElements.loadingSpinner.classList.add('hidden');
        
        const showToast = (message, type = 'success') => {
            const toast = DOMElements.toast;
            toast.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-amber-500');
            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') toast.classList.add('bg-red-500');
            else toast.classList.add('bg-amber-500');
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        };
        
        const showModal = (title, contentHTML, footerHTML) => {
            const modalHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">${title}</h2>
                            <button id="modal-close-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                                <i data-lucide="X"></i>
                            </button>
                        </div>
                        <div class="modal-body">${contentHTML}</div>
                        <div class="modal-footer mt-6 text-right">${footerHTML}</div>
                    </div>
                </div>
            `;
            DOMElements.modalContainer.innerHTML = modalHTML;
            lucide.createIcons();
            document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                if (e.target.id === 'modal-backdrop' || e.target.closest('#modal-close-btn')) {
                    closeModal();
                }
            });
        };
        
        const closeModal = () => {
            DOMElements.modalContainer.innerHTML = '';
        };

        const showPage = (pageId) => {
            document.querySelectorAll('.page, .dashboard-page').forEach(p => p.classList.add('hidden'));
            if (pageId.includes('dashboard')) {
                DOMElements.dashboardContainer.classList.remove('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            } else {
                DOMElements.dashboardContainer.classList.add('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            }
            state.activePage = pageId;
        };
        
        const navigateToSection = (sectionId, title) => {
            document.querySelectorAll('.dashboard-section').forEach(sec => sec.classList.add('hidden'));
            const section = document.getElementById(sectionId);
            if(section) {
                section.classList.remove('hidden');
                DOMElements.pageTitle.textContent = title;
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.target === sectionId);
                });
            } else {
                console.error(`Section with id ${sectionId} not found.`);
            }
        };

        const cleanupListeners = () => {
            state.unsubscribeListeners.forEach(unsub => unsub());
            state.unsubscribeListeners = [];
        };
        
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };

         const formatToYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };
        
        const getTodayDateString = () => formatToYYYYMMDD(new Date());
        
        const populateSelect = (selectId, options, textKey = null, valueKey = null) => {
            const select = document.getElementById(selectId);
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Select --</option>';
            options.forEach(opt => {
                const text = textKey ? (typeof textKey === 'function' ? textKey(opt) : opt[textKey]) : opt;
                const value = valueKey ? (typeof valueKey === 'function' ? valueKey(opt) : opt[valueKey]) : opt;
                select.innerHTML += `<option value="${value}">${text}</option>`;
            });
            select.value = currentVal;
        };

        // ===================================================================
        // ====================== DYNAMIC HTML RENDERERS =====================
        // ===================================================================
        
        const renderSidebar = (role, unreadCounts = {}) => {
            const sidebarContainer = DOMElements.dashboardContainer;
            const existingSidebar = document.getElementById('sidebar');
            if (existingSidebar) existingSidebar.remove();

            const adminLinks = [
                { id: 'admin-overview', icon: 'LayoutDashboard', text: 'Overview' },
                { id: 'admin-requests', icon: 'Send', text: 'Teacher Requests', badgeKey: 'requests' },
                { id: 'admin-attendance', icon: 'CalendarCheck', text: 'View Attendance' },
                { id: 'admin-marks', icon: 'GraduationCap', text: 'View Marks' },
                { id: 'admin-notices', icon: 'Megaphone', text: 'Manage Notices' },
                { id: 'admin-teachers', icon: 'Users', text: 'Manage Teachers' },
                { id: 'admin-students', icon: 'Contact', text: 'Manage Students' },
                { id: 'admin-chat', icon: 'MessageSquare', text: 'Group Chat', badgeKey: 'chat' },
            ];

            const teacherLinks = [
                { id: 'teacher-overview', icon: 'LayoutDashboard', text: 'Overview' },
                { id: 'teacher-attendance', icon: 'CalendarPlus', text: 'Mark Attendance' },
                { id: 'teacher-marks', icon: 'ClipboardEdit', text: 'Enter Marks' },
                { id: 'teacher-analytics', icon: 'LineChart', text: 'Analytics' },
                { id: 'teacher-requests', icon: 'Send', text: 'My Requests' },
                { id: 'teacher-chat', icon: 'MessageSquare', text: 'Group Chat', badgeKey: 'chat' },
            ];

            const links = role === 'admin' ? adminLinks : teacherLinks;
            
            const userInitial = state.currentUser?.email?.charAt(0).toUpperCase() || '?';
            const userEmail = state.currentUser?.email || 'user@example.com';
            
            const sidebarHTML = `
                <aside id="sidebar" class="sidebar flex flex-col h-full z-20">
                    <div class="sidebar-logo p-4 flex items-center gap-3 border-b border-slate-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="logo-text text-xl font-bold text-white">Adarsha Inst.</span>
                    </div>
                    <nav class="flex-grow p-2 space-y-1">
                        ${links.map(link => `
                            <a href="#" class="sidebar-link flex items-center justify-between gap-3 p-3 rounded-md" data-target="${link.id}">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="${link.icon}" class="w-5 h-5"></i>
                                    <span>${link.text}</span>
                                </div>
                                ${link.badgeKey ? `<span id="${link.badgeKey}-badge" class="badge bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>` : ''}
                            </a>
                        `).join('')}
                    </nav>
                    <div class="sidebar-footer p-3 border-t border-slate-700">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white">${userInitial}</div>
                            <div class="flex-grow">
                                <p class="font-semibold text-sm text-white user-name truncate" title="${userEmail}">${userEmail}</p>
                                <p class="text-xs text-slate-400 user-role">${role.charAt(0).toUpperCase() + role.slice(1)}</p>
                            </div>
                        </div>
                    </div>
                </aside>
            `;
            
            sidebarContainer.insertAdjacentHTML('afterbegin', sidebarHTML);
            lucide.createIcons();
        };

        const renderAdminDashboardSections = () => {
             DOMElements.adminDashboard.innerHTML = `
                <div id="admin-overview" class="dashboard-section"></div>
                <div id="admin-requests" class="dashboard-section hidden"></div>
                <div id="admin-attendance" class="dashboard-section hidden"></div>
                <div id="admin-marks" class="dashboard-section hidden"></div>
                <div id="admin-notices" class="dashboard-section hidden"></div>
                <div id="admin-teachers" class="dashboard-section hidden"></div>
                <div id="admin-students" class="dashboard-section hidden"></div>
                <div id="admin-chat" class="dashboard-section hidden"></div>
            `;
            document.getElementById('admin-overview').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900/50"><i data-lucide="Users" class="w-8 h-8 text-blue-500"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Total Teachers</p><p id="total-teachers-stat" class="text-2xl font-bold">0</p></div></div>
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-green-100 dark:bg-green-900/50"><i data-lucide="Contact" class="w-8 h-8 text-green-500"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Total Students</p><p id="total-students-stat" class="text-2xl font-bold">0</p></div></div>
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-amber-100 dark:bg-amber-900/50"><i data-lucide="Megaphone" class="w-8 h-8 text-amber-500"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Active Notices</p><p id="active-notices-stat" class="text-2xl font-bold">0</p></div></div>
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-red-100 dark:bg-red-900/50"><i data-lucide="Send" class="w-8 h-8 text-red-500"></i></div><div><p class="text-sm text-slate-500 dark:text-slate-400">Pending Requests</p><p id="pending-requests-stat" class="text-2xl font-bold">0</p></div></div>
                </div>
            `;
            document.getElementById('admin-requests').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Teacher Requests</h2><div id="admin-requests-list" class="space-y-3 max-h-[70vh] overflow-y-auto"></div></div>`;
            document.getElementById('admin-attendance').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">View Attendance Records</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><input type="date" id="admin-attendance-date" class="input-field" value="${getTodayDateString()}"><select id="admin-attendance-class" class="input-field"></select><input type="text" id="admin-attendance-subject" placeholder="Subject (Optional)" class="input-field"><button id="admin-view-attendance-btn" class="btn-primary ripple">View</button></div><div id="admin-attendance-display" class="max-h-[60vh] overflow-y-auto"><p class="text-slate-500">Select filters to view attendance.</p></div></div>`;
            document.getElementById('admin-marks').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">View Student Marks</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><select id="admin-marks-class" class="input-field"></select><button id="admin-view-marks-btn" class="btn-primary ripple">View Marks</button></div><div id="admin-marks-display" class="max-h-[60vh] overflow-y-auto"><p class="text-slate-500">Select a class to view marks.</p></div></div>`;
            document.getElementById('admin-notices').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><div class="card"><h2 class="text-xl font-bold mb-4">Post a New Notice</h2><form id="add-notice-form" class="space-y-4"><input type="text" id="notice-title" placeholder="Notice Title" class="input-field" required><textarea id="notice-content" placeholder="Notice Content..." class="input-field h-32" required></textarea><button type="submit" class="btn-primary w-full ripple">Post Notice</button></form></div></div><div class="lg:col-span-2"><div class="card"><h2 class="text-xl font-bold mb-4">Active Notices</h2><div id="admin-notices-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div></div></div></div>`;
            document.getElementById('admin-teachers').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Add New Teacher</h2><form id="add-teacher-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><input type="text" id="new-teacher-name" placeholder="Full Name" class="input-field" required><input type="email" id="new-teacher-email" placeholder="Email" class="input-field" required><input type="password" id="new-teacher-password" placeholder="Temporary Password" class="input-field" required><div class="md:col-span-3"><button type="submit" class="btn-primary ripple">Add Teacher</button></div></form></div><div class="card"><h2 class="text-xl font-bold mb-4">Teacher List</h2><div id="teacher-list-container" class="max-h-[500px] overflow-y-auto"></div></div>`;
            document.getElementById('admin-students').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Add New Student</h2><form id="add-student-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><input type="text" id="new-student-name" placeholder="Full Name" class="input-field" required><input type="text" id="new-student-class" placeholder="Class (e.g., 10th A)" class="input-field" required><input type="text" id="new-student-roll" placeholder="Roll Number" class="input-field" required><div><button type="submit" class="btn-primary ripple">Add Student</button></div></form></div><div class="card"><h2 class="text-xl font-bold mb-4">Student List</h2><div class="flex gap-4 mb-4"><input type="text" id="student-search-input" placeholder="Search students..." class="input-field flex-grow"><select id="student-class-filter" class="input-field w-auto"></select></div><div id="student-list-container" class="max-h-[500px] overflow-y-auto"></div></div>`;
            renderChatUI('admin-chat');
        };

        const renderTeacherDashboardSections = () => {
            DOMElements.teacherDashboard.innerHTML = `
                <div id="teacher-overview" class="dashboard-section"></div>
                <div id="teacher-attendance" class="dashboard-section hidden"></div>
                <div id="teacher-marks" class="dashboard-section hidden"></div>
                <div id="teacher-analytics" class="dashboard-section hidden"></div>
                <div id="teacher-requests" class="dashboard-section hidden"></div>
                <div id="teacher-chat" class="dashboard-section hidden"></div>
            `;
            document.getElementById('teacher-overview').innerHTML = `<div class="card"><h2 class="text-2xl font-bold">Welcome, <span id="teacher-welcome-name"></span>!</h2><p class="text-slate-500">Here's a summary of your assigned classes and subjects.</p><div id="teacher-assigned-classes" class="mt-4 space-y-2"></div></div>`;
            document.getElementById('teacher-attendance').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Mark Attendance</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><select id="teacher-attendance-class-subject" class="input-field"></select><input type="date" id="teacher-attendance-date" class="input-field" value="${getTodayDateString()}"><button id="teacher-load-students-btn" class="btn-primary ripple">Load Students</button></div><div id="teacher-attendance-sheet"></div></div>`;
            document.getElementById('teacher-marks').innerHTML = `<div class="card">
                <h2 class="text-xl font-bold mb-4">Enter Marks</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 items-end">
                    <div><label class="text-sm font-medium text-slate-600 dark:text-slate-400">Test Name</label><input type="text" id="teacher-marks-test-name" placeholder="e.g., Chapter 5 Test" class="input-field"></div>
                    <div><label class="text-sm font-medium text-slate-600 dark:text-slate-400">Class</label><select id="teacher-marks-class" class="input-field"></select></div>
                    <div><label class="text-sm font-medium text-slate-600 dark:text-slate-400">Subject</label><select id="teacher-marks-subject" class="input-field"></select></div>
                    <div><label class="text-sm font-medium text-slate-600 dark:text-slate-400">Max Marks</label><input type="number" id="teacher-marks-max" placeholder="e.g., 100" class="input-field"></div>
                    <div class="lg:col-span-4">
                        <button id="teacher-load-marks-sheet-btn" class="btn-primary ripple">Load Marks Sheet</button>
                    </div>
                </div>
                <div id="teacher-marks-sheet"></div>
            </div>`;
            document.getElementById('teacher-analytics').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Performance Analytics</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><select id="analytics-exam-select" class="input-field"></select><select id="analytics-class-select" class="input-field"></select></div><div id="analytics-chart-container" class="mt-4"><canvas id="marks-chart"></canvas><p id="analytics-placeholder" class="text-slate-500">Select an exam and class to view analytics.</p></div></div>`;
            document.getElementById('teacher-requests').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><div class="card"><h2 class="text-xl font-bold mb-4">Submit a New Request</h2><form id="add-request-form" class="space-y-4"><input type="text" id="request-title" placeholder="Request Subject" class="input-field" required><textarea id="request-content" placeholder="Details of your request..." class="input-field h-32" required></textarea><button type="submit" class="btn-primary w-full ripple">Submit Request</button></form></div></div><div class="lg:col-span-2"><div class="card"><h2 class="text-xl font-bold mb-4">My Past Requests</h2><div id="teacher-requests-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div></div></div></div>`;
            renderChatUI('teacher-chat');
        };
        
        const renderChatUI = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="card h-[70vh] flex flex-col">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 dark:border-slate-700">Internal Group Chat</h2>
                    <div id="${containerId}-messages" class="flex-grow overflow-y-auto mb-4 p-2 space-y-4 bg-slate-50 dark:bg-slate-800/50 rounded-md">
                        <!-- Messages will appear here -->
                    </div>
                    <form id="${containerId}-form" class="flex gap-2">
                        <input type="text" id="${containerId}-input" placeholder="Type your message..." class="input-field flex-grow" required>
                        <button type="submit" class="btn-primary ripple flex items-center gap-2">Send <i data-lucide="Send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            `;
            lucide.createIcons();
        };

        // ===================================================================
        // ======================= DATA FUNCTIONS ============================
        // ===================================================================

        const loadAttendanceSheet = async (className, subject, date) => {
            showLoading();
            const sheetContainer = document.getElementById('teacher-attendance-sheet');
            try {
                const studentsQuery = query(collection(db, 'students'), where('class', '==', className));
                const studentsSnapshot = await getDocs(studentsQuery);
                const classStudents = studentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.roll - b.roll);

                if (classStudents.length === 0) {
                    sheetContainer.innerHTML = '<p class="text-slate-500">No students found in this class.</p>';
                    hideLoading();
                    return;
                }

                const attendanceQuery = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className), where('subject', '==', subject));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const existingAttendance = {};
                attendanceSnapshot.forEach(doc => {
                    existingAttendance[doc.data().studentId] = doc.data().status;
                });

                sheetContainer.innerHTML = `
                    <h3 class="text-lg font-bold mt-4 mb-2">Attendance for ${className} - ${subject} on ${date}</h3>
                    <div class="max-h-[50vh] overflow-y-auto">
                         <table class="w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-left sticky top-0">
                                <tr><th class="p-2">Roll</th><th class="p-2">Name</th><th class="p-2 text-center">Status</th></tr>
                            </thead>
                            <tbody id="attendance-tbody">
                            ${classStudents.map(student => `
                                <tr class="border-b dark:border-slate-700" data-student-id="${student.id}" data-student-name="${student.name}" data-student-roll="${student.roll}">
                                    <td class="p-2">${student.roll}</td>
                                    <td class="p-2 font-medium">${student.name}</td>
                                    <td class="p-2 text-center">
                                        <label class="mr-2"><input type="radio" name="status-${student.id}" value="present" ${existingAttendance[student.id] === 'present' || !existingAttendance[student.id] ? 'checked' : ''} required> Present</label>
                                        <label><input type="radio" name="status-${student.id}" value="absent" ${existingAttendance[student.id] === 'absent' ? 'checked' : ''}> Absent</label>
                                    </td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-end gap-2"><button id="save-attendance-btn" class="btn-primary ripple">Save Attendance</button></div>
                `;
            } catch (error) {
                console.error("Error loading attendance sheet: ", error);
                showToast("Failed to load attendance sheet.", "error");
                sheetContainer.innerHTML = '<p class="text-red-500">Could not load student data.</p>';
            } finally {
                hideLoading();
            }
        };

        const loadMarksSheet = async (testName, className, subject, maxMarks) => {
            showLoading();
            const sheetContainer = document.getElementById('teacher-marks-sheet');
            try {
                const studentsQuery = query(collection(db, 'students'), where('class', '==', className));
                const studentsSnapshot = await getDocs(studentsQuery);
                const classStudents = studentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.roll - b.roll);

                if (classStudents.length === 0) {
                    sheetContainer.innerHTML = '<p class="text-slate-500">No students found in this class.</p>';
                    return;
                }
                
                const marksQuery = query(collection(db, 'marks'), where('testName', '==', testName), where('class', '==', className), where('subject', '==', subject));
                const marksSnapshot = await getDocs(marksQuery);
                const existingMarks = {};
                marksSnapshot.forEach(doc => {
                    existingMarks[doc.data().studentId] = doc.data().marks;
                });

                sheetContainer.innerHTML = `
                    <h3 class="text-lg font-bold mt-4 mb-2">Enter Marks for ${testName} (${subject}) - Class ${className} (Max: ${maxMarks})</h3>
                     <div class="max-h-[50vh] overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-800 text-left sticky top-0">
                                <tr><th class="p-2">Roll</th><th class="p-2">Name</th><th class="p-2">Marks</th></tr>
                            </thead>
                            <tbody id="marks-tbody">
                            ${classStudents.map(student => `
                                <tr class="border-b dark:border-slate-700" data-student-id="${student.id}" data-student-name="${student.name}" data-student-roll="${student.roll}">
                                    <td class="p-2">${student.roll}</td>
                                    <td class="p-2 font-medium">${student.name}</td>
                                    <td class="p-2"><input type="number" class="input-field" placeholder="0 - ${maxMarks}" value="${existingMarks[student.id] || ''}" max="${maxMarks}" min="0"></td>
                                </tr>
                            `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-end gap-2"><button id="save-marks-btn" class="btn-primary ripple">Save Marks</button></div>
                `;
            } catch (error) {
                console.error("Error loading marks sheet: ", error);
                showToast("Failed to load marks sheet.", "error");
            } finally {
                hideLoading();
            }
        };

        const viewAdminAttendanceRecords = async (date, className, subject) => {
            showLoading();
            const display = document.getElementById('admin-attendance-display');
            try {
                let q;
                if (subject) {
                    q = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className), where('subject', '==', subject));
                } else {
                    q = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className));
                }
                
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    display.innerHTML = `<p class="text-slate-500">No attendance records found for the selected criteria.</p>`;
                    return;
                }

                const attendanceData = snapshot.docs.map(d => d.data()).sort((a,b) => a.studentName.localeCompare(b.studentName));
                
                display.innerHTML = `
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100 dark:bg-slate-800">
                            <tr>
                                <th class="p-2 text-left">Student Name</th>
                                <th class="p-2 text-left">Status</th>
                                <th class="p-2 text-left">Subject</th>
                                <th class="p-2 text-left">Marked By</th>
                                <th class="p-2 text-left">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendanceData.map(a => `
                                <tr class="border-b dark:border-slate-700">
                                    <td class="p-2 font-medium">${a.studentName}</td>
                                    <td class="p-2">
                                        <span class="${a.status === 'present' ? 'text-green-600' : 'text-red-600'} font-semibold">${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</span>
                                    </td>
                                    <td class="p-2">${a.subject}</td>
                                    <td class="p-2">${a.teacherName}</td>
                                    <td class="p-2">${formatDate(a.timestamp)} ${formatTime(a.timestamp)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error("Error fetching attendance records:", error);
                display.innerHTML = `<p class="text-red-500">Could not fetch attendance data.</p>`;
            } finally {
                hideLoading();
            }
        };

        const viewAdminMarks = async (className) => {
            showLoading();
            const display = document.getElementById('admin-marks-display');
            try {
                const q = query(collection(db, 'marks'), where('class', '==', className));
                const snapshot = await getDocs(q);
                
                const marksData = snapshot.docs.map(d => d.data());
                
                const marksByTest = marksData.reduce((acc, mark) => {
                    const test = mark.testName || 'Unnamed Test';
                    if (!acc[test]) {
                        acc[test] = {};
                    }
                    const subject = mark.subject || 'General';
                    if (!acc[test][subject]) {
                        acc[test][subject] = { maxMarks: mark.maxMarks, marks: [] };
                    }
                    acc[test][subject].marks.push(mark);
                    acc[test][subject].marks.sort((a,b) => a.studentName.localeCompare(b.studentName));
                    return acc;
                }, {});

                if (Object.keys(marksByTest).length === 0) {
                    display.innerHTML = `<p class="text-slate-500">Marks have not been published for Class ${className} yet.</p>`;
                    return;
                }

                display.innerHTML = Object.entries(marksByTest).map(([testName, subjects]) => `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-md">${testName}</h3>
                        ${Object.entries(subjects).map(([subject, data]) => `
                            <div class="mb-6 ml-4">
                                <h4 class="font-bold text-lg mb-2">${subject} (Out of ${data.maxMarks || 'N/A'})</h4>
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 dark:bg-slate-700">
                                        <tr><th class="p-2 text-left">Student Name</th><th class="p-2 text-left">Marks Obtained</th></tr>
                                    </thead>
                                    <tbody>
                                        ${data.marks.map(m => `
                                            <tr class="border-b dark:border-slate-700">
                                                <td class="p-2 font-medium">${m.studentName}</td>
                                                <td class="p-2">${m.marks}</td>
                                            </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

            } catch (error) {
                console.error("Error fetching marks:", error);
                display.innerHTML = `<p class="text-red-500">Could not fetch marks data.</p>`;
            } finally {
                hideLoading();
            }
        };
        
        // ===================================================================
        // ======================= AUTHENTICATION ==========================
        // ===================================================================
        const handleLogin = async (email, password, role) => {
            showLoading();
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === role) {
                    state.currentUser = user;
                    state.userRole = userDocSnap.data().role;
                    initializeAppUI(state.userRole);
                    showToast('Login successful!', 'success');
                } else {
                    await signOut(auth);
                    showToast(`You are not authorized to access this dashboard.`, 'error');
                }
            } catch (error) {
                let errorMessage = "Incorrect email or password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    errorMessage = "No account found with that email address.";
                }
                showToast(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        };

        const handleLogout = async () => {
            showLoading();
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout Error: ", error);
            } finally {
                state.currentUser = null;
                state.userRole = null;
                cleanupListeners();
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.remove();
                showPage('student-portal');
                initializeStudentPortal();
                showToast('Logged out successfully.', 'success');
                hideLoading();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            showLoading();
            cleanupListeners();
            if (user) {
                 const userDocRef = doc(db, 'users', user.uid);
                 const userDocSnap = await getDoc(userDocRef);
                 if (userDocSnap.exists()) {
                    state.currentUser = user;
                    state.userRole = userDocSnap.data().role;
                    initializeAppUI(state.userRole);
                 } else { 
                    await signOut(auth);
                    showPage('login-page');
                 }
            } else { 
                if(state.activePage !== 'student-portal') {
                    showPage('login-page');
                }
                initializeStudentPortal();
            }
            hideLoading();
        });
        
        // ===================================================================
        // ======================= FIRESTORE ACTIONS =========================
        // ===================================================================
        
        const getSecondaryApp = () => {
            const secondaryAppName = 'Secondary';
            const existingApp = getApps().find(app => app.name === secondaryAppName);
            return existingApp || initializeApp(firebaseConfig, secondaryAppName);
        };
        
        const addTeacher = async (name, email, password) => {
            showLoading();
            let tempAuth;
            try {
                const secondaryApp = getSecondaryApp();
                tempAuth = getAuth(secondaryApp);
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const user = userCredential.user;
                
                await setDoc(doc(db, 'users', user.uid), { role: 'teacher' });
                await setDoc(doc(db, 'teachers', user.uid), { name, email, uid: user.uid, assignedClasses: [] });
                
                showToast('Teacher added successfully!', 'success');
                document.getElementById('add-teacher-form').reset();
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showToast('This email address is already in use.', 'error');
                else showToast(error.message, 'error');
            } finally {
                if (tempAuth) await signOut(tempAuth);
                hideLoading();
            }
        };
        
        const deleteTeacher = async (teacherId) => {
             if (!confirm("Are you sure? This will delete their login and data.")) return;
             showToast('For security, deleting user accounts must be done via a backend function. Deleting teacher data from Firestore only.', 'warning');
            showLoading();
            try {
                const batch = writeBatch(db);
                batch.delete(doc(db, 'teachers', teacherId));
                batch.delete(doc(db, 'users', teacherId));
                await batch.commit();
                showToast('Teacher data deleted from Firestore.', 'success');
            } catch(error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        };

        const addStudent = async (name, studentClass, roll) => {
            showLoading();
            try {
                const q = query(collection(db, 'students'), where('class', '==', studentClass), where('roll', '==', roll));
                if (!(await getDocs(q)).empty) {
                    showToast('A student with this roll number already exists in this class.', 'error');
                    return;
                }
                await addDoc(collection(db, 'students'), { name, class: studentClass, roll, createdAt: serverTimestamp() });
                showToast('Student added successfully!', 'success');
                document.getElementById('add-student-form').reset();
            } catch (error) {
                showToast('Failed to add student.', 'error');
            } finally {
                hideLoading();
            }
        };
        
        const deleteStudent = async (studentId) => {
            if (!confirm("Are you sure?")) return;
            showLoading();
            try {
                await deleteDoc(doc(db, "students", studentId));
                showToast("Student deleted successfully.", "success");
            } catch (error) {
                showToast("Failed to delete student.", "error");
            } finally {
                hideLoading();
            }
        };

        // ===================================================================
        // ======================= LISTENER SETUP ============================
        // ===================================================================

        const setupAdminListeners = () => {
            const unsubT = onSnapshot(collection(db, 'teachers'), s => document.getElementById('total-teachers-stat').textContent = s.size);
            const unsubS = onSnapshot(collection(db, 'students'), s => document.getElementById('total-students-stat').textContent = s.size);
            const unsubN = onSnapshot(collection(db, 'notices'), s => document.getElementById('active-notices-stat').textContent = s.size);
            const unsubR = onSnapshot(query(collection(db, 'requests'), where('status', '==', 'pending')), s => {
                const badge = document.getElementById('requests-badge');
                if(!badge) return;
                badge.textContent = s.size;
                badge.classList.toggle('hidden', s.size === 0);
                document.getElementById('pending-requests-stat').textContent = s.size;
            });
            const unsubNoticesList = onSnapshot(query(collection(db, 'notices'), orderBy('timestamp', 'desc')), snap => {
                const cont = document.getElementById('admin-notices-list');
                if(!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">No active notices.</p>'; return; }
                cont.innerHTML = snap.docs.map(d => `<div class="p-3 rounded-md bg-slate-50 dark:bg-slate-800/50 flex justify-between items-start"><div><h3 class="font-semibold">${d.data().title}</h3><p class="text-sm text-slate-500">${d.data().content}</p><p class="text-xs text-slate-400 mt-1">${formatDate(d.data().timestamp)}</p></div><button class="delete-notice-btn p-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full" data-id="${d.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></div>`).join('');
                lucide.createIcons();
            });
            const unsubTeachersList = onSnapshot(query(collection(db, 'teachers'), orderBy('name')), snap => {
                 const cont = document.getElementById('teacher-list-container');
                 if(!cont) return;
                 if(snap.empty){ cont.innerHTML = '<p class="text-slate-500">No teachers found.</p>'; return; }
                 cont.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50 dark:bg-slate-800 text-left"><tr class="border-b dark:border-slate-700"><th class="p-2">Name</th><th class="p-2">Email</th><th class="p-2">Assigned Classes</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>${snap.docs.map(d => {
                     const t = d.data();
                     return `<tr class="border-b dark:border-slate-700"><td class="p-2 font-medium">${t.name}</td><td class="p-2">${t.email}</td><td class="p-2">${t.assignedClasses.map(c => `<span class="bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${c.class} (${c.subject})</span>`).join('') || 'None'}</td><td class="p-2 text-center"><button class="assign-class-btn text-blue-500 p-1" data-id="${d.id}" data-name="${t.name}">Assign</button><button class="delete-teacher-btn text-red-500 p-1" data-id="${d.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></td></tr>`;
                 }).join('')}</tbody></table>`;
                 lucide.createIcons();
            });
            const unsubStudentsList = onSnapshot(query(collection(db, 'students')), snap => {
                 const studentsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                 studentsData.sort((a, b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name));
                 state.allStudents = studentsData;
                 state.allClasses = [...new Set(state.allStudents.map(s => s.class))].sort();
                 populateSelect('student-class-filter', state.allClasses);
                 populateSelect('admin-attendance-class', state.allClasses);
                 populateSelect('admin-marks-class', state.allClasses);
                 populateSelect('attendance-sheet-class', state.allClasses);
                 populateSelect('marks-class-select', state.allClasses);
                 const cont = document.getElementById('student-list-container');
                 if(cont) cont.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50 dark:bg-slate-800 text-left"><tr><th class="p-2">Name</th><th class="p-2">Class</th><th class="p-2">Roll</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>${state.allStudents.map(s => `<tr class="border-b dark:border-slate-700"><td class="p-2 font-medium">${s.name}</td><td class="p-2">${s.class}</td><td class="p-2">${s.roll}</td><td class="p-2 text-center"><button class="delete-student-btn p-1 text-red-500" data-id="${s.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></td></tr>`).join('')}</tbody></table>` || '<p class="text-slate-500">No students found.</p>';
                 lucide.createIcons();
            });
            const unsubRequestsAdmin = onSnapshot(query(collection(db, 'requests'), orderBy('timestamp', 'desc')), snap => {
                const cont = document.getElementById('admin-requests-list');
                if(!cont) return;
                if(snap.empty){ cont.innerHTML = '<p class="text-slate-500">No requests found.</p>'; return; }
                const statusColors = { pending: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-300', approved: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', denied: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    return `<div class="p-3 rounded-md bg-slate-50 dark:bg-slate-800/50"><div class="flex justify-between items-start"><div><h3 class="font-semibold">${r.title}</h3><p class="text-sm text-slate-600 dark:text-slate-400">From: ${r.teacherName}</p><p class="text-sm text-slate-500">${r.content}</p></div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors[r.status]}">${r.status}</span></div><p class="text-xs text-slate-400 text-right mt-1">${formatDate(r.timestamp)}</p>${r.status === 'pending' ? `<div class="flex gap-2 mt-2 border-t dark:border-slate-700 pt-2"><button class="approve-request-btn text-sm bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" data-id="${d.id}">Approve</button><button class="deny-request-btn text-sm bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${d.id}">Deny</button></div>` : ''}</div>`
                }).join('');
            });
            const unsubChat = onSnapshot(query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50)), snap => {
                const cont = document.getElementById('admin-chat-messages');
                if(!cont) return;
                cont.innerHTML = snap.docs.reverse().map(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === state.currentUser.uid;
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white' : 'bg-slate-200 dark:bg-slate-700'}"><p class="text-sm">${msg.text}</p><p class="text-xs opacity-70 mt-1 text-right">${msg.senderEmail.split('@')[0]} at ${formatTime(msg.timestamp)}</p></div></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            });
            state.unsubscribeListeners.push(unsubT, unsubS, unsubN, unsubR, unsubNoticesList, unsubTeachersList, unsubStudentsList, unsubRequestsAdmin, unsubChat);
        };
        const setupTeacherListeners = () => {
            const unsubTeacherData = onSnapshot(doc(db, 'teachers', state.currentUser.uid), docSnap => {
                if (docSnap.exists()) {
                    state.currentTeacherData = docSnap.data();
                    document.getElementById('teacher-welcome-name').textContent = state.currentTeacherData.name;
                    const classCont = document.getElementById('teacher-assigned-classes');
                    if (classCont) classCont.innerHTML = state.currentTeacherData.assignedClasses.map(c => `<div class="p-3 bg-slate-100 dark:bg-slate-800 rounded-md font-medium">${c.class} - ${c.subject}</div>`).join('') || '<p>No classes assigned.</p>';
                    populateSelect('teacher-attendance-class-subject', state.currentTeacherData.assignedClasses, c => `${c.class} - ${c.subject}`, c => `${c.class}|${c.subject}`);
                    
                    const uniqueClasses = [...new Set(state.currentTeacherData.assignedClasses.map(c => c.class))];
                    populateSelect('teacher-marks-class', uniqueClasses);
                    populateSelect('analytics-class-select', uniqueClasses);

                    const marksClassSelect = document.getElementById('teacher-marks-class');
                    if (marksClassSelect) {
                        marksClassSelect.addEventListener('change', () => {
                            const selectedClass = marksClassSelect.value;
                            const subjectsForClass = state.currentTeacherData.assignedClasses
                                .filter(c => c.class === selectedClass)
                                .map(c => c.subject);
                            populateSelect('teacher-marks-subject', subjectsForClass);
                        });
                    }
                }
            });
            
            const unsubRequests = onSnapshot(query(collection(db, 'requests'), where('teacherId', '==', state.currentUser.uid), orderBy('timestamp', 'desc')), snap => {
                 const cont = document.getElementById('teacher-requests-list');
                if(!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">You have not submitted any requests.</p>'; return; }
                 cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    const statusColors = { pending: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-300', approved: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', denied: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                    return `<div class="p-3 rounded-md bg-slate-50 dark:bg-slate-800/50"><div class="flex justify-between items-start"><div><h3 class="font-semibold">${r.title}</h3><p class="text-sm text-slate-500">${r.content}</p></div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors[r.status]}">${r.status}</span></div><p class="text-xs text-slate-400 text-right mt-1">${formatDate(r.timestamp)}</p></div>`;
                }).join('');
            });
            const unsubChat = onSnapshot(query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50)), snap => {
                const cont = document.getElementById('teacher-chat-messages');
                if(!cont) return;
                cont.innerHTML = snap.docs.reverse().map(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === state.currentUser.uid;
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white' : 'bg-slate-200 dark:bg-slate-700'}"><p class="text-sm">${msg.text}</p><p class="text-xs opacity-70 mt-1 text-right">${msg.senderEmail.split('@')[0]} at ${formatTime(msg.timestamp)}</p></div></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            });
            state.unsubscribeListeners.push(unsubTeacherData, unsubRequests, unsubChat);
        };
        
        // ===================================================================
        // ========================= UI INITIALIZATION =======================
        // ===================================================================
        
        const initializeAppUI = (role) => {
            renderSidebar(role);
            if (role === 'admin') {
                renderAdminDashboardSections();
                showPage('admin-dashboard');
                navigateToSection('admin-overview', 'Admin Overview');
                setupAdminListeners();
            } else if (role === 'teacher') {
                renderTeacherDashboardSections();
                showPage('teacher-dashboard');
                navigateToSection('teacher-overview', 'Teacher Overview');
                setupTeacherListeners();
            }
            attachDashboardEventListeners();
            lucide.createIcons();
        };

        const initializeStudentPortal = () => {
            const noticesQuery = query(collection(db, 'notices'), orderBy('timestamp', 'desc'));
            const unsubNotices = onSnapshot(noticesQuery, (snapshot) => {
                const container = document.getElementById('student-notices-list');
                if(!container) return;
                if (snapshot.empty) { container.innerHTML = `<p class="text-slate-500">No notices available at the moment.</p>`; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const notice = doc.data();
                    return `<div class="p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700"><h3 class="font-bold text-md">${notice.title}</h3><p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${notice.content}</p><p class="text-xs text-slate-400 dark:text-slate-500 mt-2 text-right">Posted on: ${formatDate(notice.timestamp)}</p></div>`;
                }).join('');
            });
            
            const todayStr = getTodayDateString();
            const absenteesQuery = query(collection(db, 'attendance'), where('date', '==', todayStr), where('status', '==', 'absent'));
            const unsubAbsentees = onSnapshot(absenteesQuery, (snapshot) => {
                 const container = document.getElementById('student-absentees-list');
                 if(!container) return;
                 if (snapshot.empty) { container.innerHTML = `<p class="text-slate-500">No absentees reported for today yet.</p>`; return; }
                const absenteeData = snapshot.docs.map(doc => doc.data());
                container.innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-100 dark:bg-slate-800"><tr><th class="p-2">Student Name</th><th class="p-2">Class</th><th class="p-2">Subject</th><th class="p-2">Marked By</th></tr></thead><tbody>${absenteeData.map(a => `<tr class="border-b dark:border-slate-700"><td class="p-2">${a.studentName}</td><td class="p-2">${a.class}</td><td class="p-2">${a.subject}</td><td class="p-2">${a.teacherName}</td></tr>`).join('')}</tbody></table>`;
            });
            
            const marksQuery = query(collection(db, 'marks'));
            const unsubMarks = onSnapshot(marksQuery, (snapshot) => {
                const display = document.getElementById('student-marks-display');
                if (!display) return;
                if (snapshot.empty) {
                    display.innerHTML = `<p class="text-slate-500">No marks have been published yet.</p>`;
                    return;
                }

                const marksData = snapshot.docs.map(d => d.data());
                
                const marksByClass = marksData.reduce((acc, mark) => {
                    const className = mark.class;
                    const testName = mark.testName || 'Unnamed Test';
                    const subject = mark.subject || 'General';

                    if (!acc[className]) acc[className] = {};
                    if (!acc[className][testName]) acc[className][testName] = {};
                    if (!acc[className][testName][subject]) {
                        acc[className][testName][subject] = { maxMarks: mark.maxMarks, marks: [] };
                    }
                    acc[className][testName][subject].marks.push(mark);
                    return acc;
                }, {});
                
                display.innerHTML = Object.entries(marksByClass).map(([className, tests]) => {
                    return `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/50 rounded-lg sticky top-0">${className}</h2>
                        ${Object.entries(tests).map(([testName, subjects]) => `
                            <div class="mb-8 ml-4">
                                <h3 class="text-xl font-semibold mb-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-md">${testName}</h3>
                                ${Object.entries(subjects).map(([subject, data]) => `
                                    <div class="mb-6 ml-4">
                                        <h4 class="font-bold text-lg mb-2">${subject} (Out of ${data.maxMarks || 'N/A'})</h4>
                                        <table class="w-full text-sm">
                                            <thead class="bg-slate-50 dark:bg-slate-700">
                                                <tr><th class="p-2 text-left">Student Name</th><th class="p-2 text-left">Marks Obtained</th></tr>
                                            </thead>
                                            <tbody>
                                                ${data.marks.sort((a,b) => a.studentName.localeCompare(b.studentName)).map(m => `
                                                    <tr class="border-b dark:border-slate-700">
                                                        <td class="p-2 font-medium">${m.studentName}</td>
                                                        <td class="p-2">${m.marks}</td>
                                                    </tr>`).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>`;
                }).join('');
            });

            state.unsubscribeListeners.push(unsubNotices, unsubAbsentees, unsubMarks);
        };
        
        const initTheme = () => {
            const themeToggle = document.getElementById('theme-toggle');
            const studentThemeToggle = document.getElementById('student-theme-toggle');
            const sunIcon = `<i data-lucide="Sun" class="w-6 h-6"></i>`, moonIcon = `<i data-lucide="Moon" class="w-6 h-6"></i>`;
            const applyTheme = (theme) => {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                themeToggle.innerHTML = studentThemeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
                lucide.createIcons();
            };
            const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(initialTheme);
            const toggleTheme = () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };
            themeToggle.addEventListener('click', toggleTheme);
            studentThemeToggle.addEventListener('click', toggleTheme);
        };
        
        // ===================================================================
        // ========================= EVENT LISTENERS =========================
        // ===================================================================

        const attachAllDashboardActionListeners = () => {
            const app = document.getElementById('app');
            app.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formId = e.target.id;
                
                if (formId === 'add-teacher-form') addTeacher(e.target.querySelector('#new-teacher-name').value, e.target.querySelector('#new-teacher-email').value, e.target.querySelector('#new-teacher-password').value);
                if (formId === 'add-student-form') addStudent(e.target.querySelector('#new-student-name').value, e.target.querySelector('#new-student-class').value, e.target.querySelector('#new-student-roll').value);
                
                let collectionName, docData;
                if (formId === 'add-notice-form') { collectionName = 'notices'; docData = { title: e.target.querySelector('#notice-title').value, content: e.target.querySelector('#notice-content').value, timestamp: serverTimestamp() }; }
                if (formId === 'add-request-form') { collectionName = 'requests'; docData = { title: e.target.querySelector('#request-title').value, content: e.target.querySelector('#request-content').value, teacherId: state.currentUser.uid, teacherName: state.currentTeacherData.name, status: 'pending', timestamp: serverTimestamp() }; }
                if (formId.includes('-chat-form')) { 
                    collectionName = 'chat'; 
                    const input = e.target.querySelector('input');
                    docData = { text: input.value, senderId: state.currentUser.uid, senderEmail: state.currentUser.email, role: state.userRole, timestamp: serverTimestamp() };
                    if (docData.text) input.value = ''; else return;
                }
                if(collectionName) {
                    await addDoc(collection(db, collectionName), docData);
                    showToast('Success!', 'success');
                    if(!formId.includes('-chat-form')) e.target.reset();
                }
            });

            app.addEventListener('click', async (e) => {
                const target = e.target;
                const classList = target.classList;

                // Admin buttons
                if (classList.contains('delete-notice-btn')) deleteDoc(doc(db, 'notices', target.dataset.id));
                if (classList.contains('delete-teacher-btn')) deleteTeacher(target.dataset.id);
                if (classList.contains('delete-student-btn')) deleteStudent(target.dataset.id);
                if (classList.contains('approve-request-btn')) updateDoc(doc(db, 'requests', target.dataset.id), { status: 'approved' });
                if (classList.contains('deny-request-btn')) updateDoc(doc(db, 'requests', target.dataset.id), { status: 'denied' });
                if (classList.contains('assign-class-btn')) {
                    const teacherId = target.dataset.id, teacherName = target.dataset.name;
                    showModal(`Assign Class to ${teacherName}`, 
                        `<div class="space-y-4"><input type="text" id="assign-class-name" placeholder="Class Name (e.g., 10th A)" class="input-field"><input type="text" id="assign-subject-name" placeholder="Subject Name (e.g., Mathematics)" class="input-field"></div>`, 
                        `<button id="confirm-assign-btn" class="btn-primary ripple">Assign</button>`);
                    document.getElementById('confirm-assign-btn').onclick = async () => {
                        const className = document.getElementById('assign-class-name').value, subjectName = document.getElementById('assign-subject-name').value;
                        if (!className || !subjectName) { showToast('All fields required.', 'error'); return; }
                        const teacherRef = doc(db, 'teachers', teacherId);
                        const teacherSnap = await getDoc(teacherRef);
                        if(teacherSnap.exists()){
                            await updateDoc(teacherRef, { assignedClasses: [...teacherSnap.data().assignedClasses || [], { class: className, subject: subjectName }] });
                            showToast('Class assigned!', 'success');
                            closeModal();
                        }
                    };
                }
                 if(target.id === 'admin-view-marks-btn') {
                    const className = document.getElementById('admin-marks-class').value;
                    if (!className) { showToast('Please select a class.', 'error'); return; }
                    viewAdminMarks(className);
                }
                if(target.id === 'admin-view-attendance-btn') {
                    const date = document.getElementById('admin-attendance-date').value;
                    const className = document.getElementById('admin-attendance-class').value;
                    const subject = document.getElementById('admin-attendance-subject').value;
                    if (!date || !className) { 
                        showToast('Please select a date and class.', 'error'); 
                        return; 
                    }
                    viewAdminAttendanceRecords(date, className, subject.trim());
                }

                // Teacher buttons
                if (target.id === 'teacher-load-students-btn') {
                    const sel = document.getElementById('teacher-attendance-class-subject');
                    const date = document.getElementById('teacher-attendance-date').value;
                    if (!sel.value || !date) { showToast('Please select all fields.', 'error'); return; }
                    const [className, subject] = sel.value.split('|');
                    loadAttendanceSheet(className, subject, date);
                }
                if (target.id === 'teacher-load-marks-sheet-btn') {
                    const testName = document.getElementById('teacher-marks-test-name').value;
                    const className = document.getElementById('teacher-marks-class').value;
                    const subject = document.getElementById('teacher-marks-subject').value;
                    const maxMarks = document.getElementById('teacher-marks-max').value;
                    if (!testName || !className || !subject || !maxMarks) { showToast('Please fill out all fields.', 'error'); return; }
                    if (Number(maxMarks) <= 0) { showToast('Maximum marks must be a positive number.', 'error'); return; }
                    loadMarksSheet(testName, className, subject, maxMarks);
                }
                if (target.id === 'save-attendance-btn') {
                    const [className, subject] = document.getElementById('teacher-attendance-class-subject').value.split('|');
                    const date = document.getElementById('teacher-attendance-date').value;
                    const rows = document.querySelectorAll('#attendance-tbody tr');
                    if (rows.length === 0) return;
                    showLoading();
                    try {
                        const batch = writeBatch(db);
                        rows.forEach(row => {
                            const studentId = row.dataset.studentId, studentName = row.dataset.studentName;
                            const status = row.querySelector(`input:checked`).value;
                            const docId = `${date}_${className}_${subject}_${studentId}`.replace(/\s+/g, '_');
                            batch.set(doc(db, 'attendance', docId), { date, class: className, subject, studentId, studentName, status, teacherId: state.currentUser.uid, teacherName: state.currentTeacherData.name, timestamp: serverTimestamp() });
                        });
                        await batch.commit();
                        showToast('Attendance saved!', 'success');
                    } catch (error) { showToast('Failed to save attendance.', 'error'); } 
                    finally { hideLoading(); }
                }
                if (target.id === 'save-marks-btn') {
                    const testName = document.getElementById('teacher-marks-test-name').value;
                    const className = document.getElementById('teacher-marks-class').value;
                    const subject = document.getElementById('teacher-marks-subject').value;
                    const maxMarks = Number(document.getElementById('teacher-marks-max').value);
                    const rows = document.querySelectorAll('#marks-tbody tr');
                    if (rows.length === 0) return;

                    let validationPassed = true;
                    rows.forEach(row => {
                        const marksInput = row.querySelector('input[type="number"]');
                        if (Number(marksInput.value) > maxMarks) {
                            marksInput.style.borderColor = 'red';
                            validationPassed = false;
                        } else {
                            marksInput.style.borderColor = '';
                        }
                    });

                    if (!validationPassed) {
                        showToast('One or more marks exceed the maximum value.', 'error');
                        return;
                    }

                    showLoading();
                    try {
                        const batch = writeBatch(db);
                        rows.forEach(row => {
                            const studentId = row.dataset.studentId;
                            const marks = row.querySelector('input[type="number"]').value;
                            if (marks !== '') {
                                const docId = `${testName}_${className}_${subject}_${studentId}`.replace(/\s+/g, '_');
                                batch.set(doc(db, 'marks', docId), { 
                                    testName: testName, 
                                    class: className, 
                                    subject: subject,
                                    maxMarks: maxMarks,
                                    studentId, 
                                    studentName: row.dataset.studentName, 
                                    marks: Number(marks), 
                                    teacherId: state.currentUser.uid, 
                                    teacherName: state.currentTeacherData.name, 
                                    timestamp: serverTimestamp() 
                                });
                            }
                        });
                        await batch.commit();
                        showToast('Marks saved!', 'success');
                    } catch (error) { 
                        console.error("Error saving marks: ", error);
                        showToast('Failed to save marks.', 'error'); 
                    } 
                    finally { hideLoading(); }
                }
                // Student portal buttons
                 if (target.id === 'view-attendance-sheet-btn') {
                    showToast('This feature is under development.', 'info');
                }
            });
        };

        const attachLoginEventListeners = () => {
            document.getElementById('admin-login-tab').addEventListener('click', () => {
                document.getElementById('teacher-login-tab').classList.remove('active', 'text-indigo-600', 'border-indigo-600');
                document.getElementById('admin-login-tab').classList.add('active', 'text-indigo-600', 'border-indigo-600');
                document.getElementById('admin-login-form').classList.remove('hidden');
                document.getElementById('teacher-login-form').classList.add('hidden');
            });

            document.getElementById('teacher-login-tab').addEventListener('click', () => {
                document.getElementById('admin-login-tab').classList.remove('active', 'text-indigo-600', 'border-indigo-600');
                document.getElementById('teacher-login-tab').classList.add('active', 'text-indigo-600', 'border-indigo-600');
                document.getElementById('teacher-login-form').classList.remove('hidden');
                document.getElementById('admin-login-form').classList.add('hidden');
            });
            
            document.getElementById('admin-login-form').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('admin-email').value, document.getElementById('admin-password').value, 'admin'); });
            document.getElementById('teacher-login-form').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(document.getElementById('teacher-email').value, document.getElementById('teacher-password').value, 'teacher'); });
            document.getElementById('go-to-student-portal').addEventListener('click', (e) => { e.preventDefault(); showPage('student-portal'); });
            document.getElementById('go-to-login').addEventListener('click', (e) => { e.preventDefault(); cleanupListeners(); showPage('login-page'); });
        };
        const attachDashboardEventListeners = () => {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.dataset.target;
                        const title = link.querySelector('span').textContent;
                        navigateToSection(targetId, title);
                    }
                });
            }
            
            document.getElementById('header-logout-btn').addEventListener('click', handleLogout);

            document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                document.getElementById('sidebar')?.classList.toggle('collapsed');
            });
        };
        
        // ===================================================================
        // ========================= APP INITIALIZATION ======================
        // ===================================================================
        
        const init = () => {
            attachLoginEventListeners();
            initTheme();
            attachAllDashboardActionListeners(); 
            if (window.location.hash === '#login-page') showPage('login-page');
            else showPage('student-portal');
        };

        window.addEventListener('load', init);
    </script>

</body>
</html>

