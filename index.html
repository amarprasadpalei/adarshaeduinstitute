<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adarsha Educational Institute</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <style>
        /* Base Styling & Theme Variables */
        :root {
            --background: #f1f5f9; /* A slightly cooler gray */
            --foreground: #ffffff;
            --sidebar: #1e293b;
            --sidebar-foreground: #cbd5e1;
            --sidebar-hover: #334155;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --input: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--background); }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .sidebar-link-animated {
            opacity: 0; /* Start hidden */
            animation: slideInLeft 0.5s ease-out forwards;
        }

        /* Ripple Effect for Buttons */
        .ripple {
            background-position: center;
            transition: background 0.8s;
        }
        .ripple:hover {
            background: var(--primary-hover) radial-gradient(circle, transparent 1%, var(--primary-hover) 1%) center/15000%;
        }
        .ripple:active {
            background-color: var(--primary);
            background-size: 100%;
            transition: background 0s;
        }

        /* Custom Styles for App Elements */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: var(--sidebar);
            color: var(--sidebar-foreground);
            transition: width 0.3s ease-in-out;
            flex-shrink: 0;
        }
        
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--background);
            transition: margin-left 0.3s ease-in-out;
        }

        .sidebar-link {
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-link:hover, .sidebar-link.active {
            background-color: var(--sidebar-hover);
            color: white;
        }
        
        .sidebar.collapsed {
            width: 72px;
        }
        .sidebar.collapsed .sidebar-link span, 
        .sidebar.collapsed .sidebar-link .badge,
        .sidebar.collapsed .sidebar-logo .logo-text,
        .sidebar.collapsed .sidebar-footer .user-name,
        .sidebar.collapsed .sidebar-footer .user-role {
            display: none;
        }
        .sidebar.collapsed .sidebar-footer {
            justify-content: center;
        }

        /* Responsive Sidebar for Mobile */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 40;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar.collapsed {
                width: 260px;
            }
            .sidebar.collapsed .sidebar-link span, 
            .sidebar.collapsed .sidebar-link .badge,
            .sidebar.collapsed .sidebar-logo .logo-text,
            .sidebar.collapsed .sidebar-footer .user-name,
            .sidebar.collapsed .sidebar-footer .user-role {
                display: inline-block;
            }
            .sidebar.collapsed .sidebar-footer {
                justify-content: flex-start;
            }
        }


        /* General Card/Panel Styling */
        .card {
            background-color: var(--foreground);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card.interactive:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            font-weight: 500;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .input-field {
            background-color: var(--input);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            color: var(--text-primary);
        }
        
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: var(--foreground);
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 600px;
            width: 90%;
            animation: fadeIn 0.3s;
        }

        .digital-clock {
            font-family: 'Courier New', Courier, monospace;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 0.05em;
            background: #e2e8f0; /* slate-200 */
            color: #334155; /* slate-700 */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .digital-clock {
                padding: 0.5rem 1rem;
                font-size: 1.1rem;
                letter-spacing: 0.1em;
            }
        }
        #student-portal .digital-clock {
            background: rgba(0,0,0,0.2);
            color: #e0e7ff; /* indigo-200 */
            /* Make the clock more compact */
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem; /* smaller font */
            letter-spacing: 0.025em;
        }
        /* Override the default responsive sizing for the portal clock */
        @media (min-width: 640px) {
             #student-portal .digital-clock {
                padding: 0.25rem 0.6rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-600"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-[99]">
        <p>This is a toast message!</p>
    </div>

    <!-- MAIN APPLICATION CONTAINER -->
    <div id="app">

        <!-- =================================================================== -->
        <!-- ======================== LOGIN PAGE =============================== -->
        <!-- =================================================================== -->
        <section id="login-page" class="page hidden flex items-center justify-center min-h-screen bg-slate-100 fade-in">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-600"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    <h1 class="text-3xl font-bold text-slate-800 mt-2">Adarsha Educational Institute</h1>
                    <p class="text-slate-500">Welcome back! Please sign in to your account.</p>
                </div>

                <div class="card bg-white p-8">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <button id="admin-login-btn" class="login-type-btn active flex items-center justify-center gap-2 py-3 px-4 font-semibold text-white bg-indigo-600 rounded-md transition-all duration-300 transform hover:scale-105">
                            <i data-lucide="Shield"></i> Admin Login
                        </button>
                        <button id="teacher-login-btn" class="login-type-btn flex items-center justify-center gap-2 py-3 px-4 font-semibold text-slate-600 bg-slate-200 rounded-md transition-all duration-300 transform hover:scale-105">
                            <i data-lucide="User"></i> Teacher Login
                        </button>
                    </div>

                    <!-- Admin Login Form -->
                    <form id="admin-login-form" class="space-y-4">
                        <h3 class="font-bold text-center text-lg text-slate-700">Admin Sign In</h3>
                        <input type="email" id="admin-email" placeholder="Admin Email" class="input-field" required>
                        <input type="password" id="admin-password" placeholder="Password" class="input-field" required>
                        <button type="submit" class="btn-primary w-full ripple">Sign In</button>
                    </form>

                    <!-- Teacher Login Form -->
                    <form id="teacher-login-form" class="space-y-4 hidden">
                        <h3 class="font-bold text-center text-lg text-slate-700">Teacher Sign In</h3>
                        <input type="email" id="teacher-email" placeholder="Teacher Email" class="input-field" required>
                        <input type="password" id="teacher-password" placeholder="Password" class="input-field" required>
                        <button type="submit" class="btn-primary w-full ripple">Sign In</button>
                    </form>
                </div>
                 <p class="text-center text-sm text-slate-500 mt-6">
                    Looking for the student portal? <a href="#student-portal" id="go-to-student-portal" class="font-semibold text-indigo-600 hover:underline">Click here</a>.
                </p>
            </div>
        </section>

        <!-- =================================================================== -->
        <!-- ====================== DASHBOARD CONTAINER ======================== -->
        <!-- =================================================================== -->
        <div id="dashboard-container" class="app-container hidden">
            <!-- Sidebar is dynamically inserted here -->
             <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>
            
            <!-- Main Content Area -->
            <main class="main-content">
                <header class="p-4 md:p-6 bg-white/80 backdrop-blur-sm sticky top-0 z-20 flex items-center justify-between border-b border-slate-200">
                    <div class="flex items-center gap-2 sm:gap-4 min-w-0">
                        <button id="sidebar-toggle" class="p-2 rounded-full hover:bg-slate-200 md:hidden flex-shrink-0">
                            <i data-lucide="Menu" class="w-6 h-6"></i>
                        </button>
                        <button id="desktop-sidebar-toggle" class="hidden md:block p-2 rounded-full hover:bg-slate-200 flex-shrink-0">
                            <i data-lucide="PanelLeftClose" class="w-6 h-6"></i>
                        </button>
                        <h1 id="page-title" class="text-xl md:text-2xl font-bold truncate">Dashboard</h1>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
                        <div id="user-avatar" class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-700 border-2 border-indigo-300">
                            A
                        </div>
                        <button id="header-logout-btn" class="flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-2 rounded-md bg-slate-100 hover:bg-slate-200 transition-colors whitespace-nowrap" title="Logout">
                            <i data-lucide="LogOut" class="w-4 h-4 sm:w-5 sm:h-5 text-slate-600"></i>
                            <span class="font-semibold text-slate-700 text-sm">Logout</span>
                        </button>
                    </div>
                </header>
                
                <div class="p-4 md:p-6 space-y-6">
                    <!-- =================================================================== -->
                    <!-- ======================= ADMIN DASHBOARD ========================= -->
                    <!-- =================================================================== -->
                    <section id="admin-dashboard" class="dashboard-page hidden space-y-6">
                        <!-- Admin Subsections will be dynamically shown here -->
                    </section>
                    
                    <!-- =================================================================== -->
                    <!-- ======================= TEACHER DASHBOARD ======================= -->
                    <!-- =================================================================== -->
                    <section id="teacher-dashboard" class="dashboard-page hidden space-y-6">
                        <!-- Teacher Subsections will be dynamically shown here -->
                    </section>
                </div>
            </main>
        </div>

        <!-- =================================================================== -->
        <!-- =================== STUDENT & PARENT PORTAL ======================= -->
        <!-- =================================================================== -->
        <section id="student-portal" class="page fade-in">
            <!-- Student Portal content goes here -->
             <header class="bg-indigo-600 text-white shadow-md">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div class="flex items-center min-w-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                            <span class="ml-3 text-lg sm:text-xl font-bold truncate">Adarsha Educational Institute</span>
                        </div>
                        <div class="flex flex-col items-end gap-1 flex-shrink-0">
                             <div id="portal-digital-clock" class="digital-clock">00:00:00 AM</div>
                            <a href="#login-page" id="go-to-login" class="px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium bg-white text-indigo-600 rounded-md hover:bg-indigo-50 transition whitespace-nowrap">Admin/Teacher Login</a>
                        </div>
                    </div>
                </div>
            </header>

            <main class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
                 <div id="student-stats-grid">
                    <div class="card interactive">
                         <div class="grid grid-cols-3 divide-x divide-slate-200 -m-4">
                             <div class="p-4 flex flex-col items-center justify-center gap-2 text-center">
                                 <div class="p-2 rounded-full bg-green-100"><i data-lucide="Contact" class="w-6 h-6 text-green-500"></i></div>
                                 <div><p id="portal-student-count" class="text-xl font-bold">0</p><p class="text-xs text-slate-500">Students</p></div>
                             </div>
                             <div class="p-4 flex flex-col items-center justify-center gap-2 text-center">
                                 <div class="p-2 rounded-full bg-blue-100"><i data-lucide="Users" class="w-6 h-6 text-blue-500"></i></div>
                                 <div><p id="portal-teacher-count" class="text-xl font-bold">0</p><p class="text-xs text-slate-500">Total Teachers</p></div>
                             </div>
                             <div class="p-4 flex flex-col items-center justify-center gap-2 text-center">
                                 <div class="p-2 rounded-full bg-purple-100"><i data-lucide="Book" class="w-6 h-6 text-purple-500"></i></div>
                                 <div><p id="portal-subject-count" class="text-xl font-bold">0</p><p class="text-xs text-slate-500">Subjects</p></div>
                             </div>
                         </div>
                    </div>
                 </div>

                 <div id="student-main-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Notices Card -->
                    <div class="lg:col-span-2 card interactive">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="Megaphone" class="w-6 h-6 mr-2 text-indigo-500"></i>
                            Notice Board
                        </h2>
                        <div id="student-notices-list" class="space-y-4 max-h-96 overflow-y-auto">
                             <p class="text-slate-500">No notices available at the moment.</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                         <!-- Upcoming Exams Card -->
                        <div class="card interactive">
                            <h2 class="text-xl font-bold mb-4 flex items-center">
                                <i data-lucide="CalendarDays" class="w-6 h-6 mr-2 text-amber-500"></i>
                                Upcoming Exams
                            </h2>
                            <div id="student-exams-list" class="space-y-3 max-h-40 overflow-y-auto">
                               <p class="text-slate-500">No upcoming exams scheduled.</p>
                            </div>
                        </div>

                         <!-- Daily Absentees Tile -->
                        <div id="absentee-card" class="card interactive cursor-pointer">
                             <div class="flex items-center justify-between">
                                 <div class="flex items-center gap-4">
                                     <div class="p-3 rounded-full bg-red-100"><i data-lucide="UserX" class="w-8 h-8 text-red-500"></i></div>
                                     <div>
                                         <p class="text-sm text-slate-500">Today's Absentees</p>
                                         <p id="absentee-count" class="text-2xl font-bold">0</p>
                                     </div>
                                 </div>
                                 <i data-lucide="ArrowRight" class="text-slate-400"></i>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Published Attendance Sheets -->
                    <div class="card interactive md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="Sheet" class="w-6 h-6 mr-2 text-sky-500"></i>
                            Published Attendance Sheets
                        </h2>
                        <div class="flex items-center gap-4 mb-4">
                            <select id="attendance-sheet-month" class="input-field w-auto">
                                <!-- Months will be populated here -->
                            </select>
                             <select id="attendance-sheet-class" class="input-field w-auto">
                                <!-- Classes will be populated here -->
                            </select>
                            <button id="view-attendance-sheet-btn" class="btn-primary ripple">View</button>
                        </div>
                        <div id="student-attendance-sheets-display" class="max-h-[500px] overflow-y-auto">
                           <p class="text-slate-500">Select a month and class to view published attendance sheets.</p>
                        </div>
                    </div>
                    
                     <!-- Published Marks Sheets -->
                    <div class="card interactive md:col-span-2 lg:grid-cols-3">
                        <h2 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="GraduationCap" class="w-6 h-6 mr-2 text-green-500"></i>
                            All Published Marks
                        </h2>
                        <div id="student-marks-display" class="max-h-[60vh] overflow-y-auto">
                           <p class="text-slate-500">Loading all published marks...</p>
                        </div>
                    </div>

                </div>
            </main>
        </section>

    </div> <!-- End #app -->

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp, getApps, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            deleteUser,
            reauthenticateWithCredential,
            EmailAuthProvider,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            addDoc,
            collection,
            onSnapshot,
            query,
            where,
            serverTimestamp,
            writeBatch,
            getDocs,
            deleteDoc,
            orderBy,
            limit,
            updateDoc,
            Timestamp,
            startAt,
            endAt
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
         import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // ===================================================================
        // ====================== FIREBASE CONFIG ============================
        // ===================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCq4cAvfe2_-y2beX2yiSkSAnSgTWDwhQY",
            authDomain: "aeiwebsiteai.firebaseapp.com",
            databaseURL: "https://aeiwebsiteai-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aeiwebsiteai",
            storageBucket: "aeiwebsiteai.appspot.com",
            messagingSenderId: "238874682793",
            appId: "1:238874682793:web:d9be489483f042b1c950b8"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- NEW ---
        // Automatically log out any existing user on every page load to ensure a fresh session.
        signOut(auth).catch(error => console.log("No active session to log out or logout failed:", error));
        // -----------

        // Global State
        const state = {
            currentUser: null,
            userRole: null,
            activePage: 'student-portal', // Default to student portal
            unsubscribeListeners: [],
            allClasses: [],
            allExams: [],
            allStudents: [],
            currentTeacherData: null,
            marksChart: null,
            teacherStatuses: {},
            charts: {},
            clockInterval: null,
        };

        // DOM Elements
        const DOMElements = {
            loadingSpinner: document.getElementById('loading-spinner'),
            toast: document.getElementById('toast-notification'),
            pages: document.querySelectorAll('.page'),
            dashboardContainer: document.getElementById('dashboard-container'),
            loginPage: document.getElementById('login-page'),
            adminDashboard: document.getElementById('admin-dashboard'),
            teacherDashboard: document.getElementById('teacher-dashboard'),
            studentPortal: document.getElementById('student-portal'),
            pageTitle: document.getElementById('page-title'),
            modalContainer: document.getElementById('modal-container'),
        };

        // ===================================================================
        // ===================== UTILITY FUNCTIONS ===========================
        // ===================================================================

        const showLoading = () => DOMElements.loadingSpinner.classList.remove('hidden');
        const hideLoading = () => DOMElements.loadingSpinner.classList.add('hidden');
        
        const showToast = (message, type = 'success') => {
            const toast = DOMElements.toast;
            toast.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500', 'bg-amber-500');
            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') toast.classList.add('bg-red-500');
            else toast.classList.add('bg-amber-500');
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        };
        
        const showModal = (title, contentHTML, footerHTML) => {
            const modalHTML = `
                <div class="modal-backdrop" id="modal-backdrop">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">${title}</h2>
                            <button id="modal-close-btn" class="p-1 rounded-full hover:bg-slate-200">
                                <i data-lucide="X"></i>
                            </button>
                        </div>
                        <div class="modal-body">${contentHTML}</div>
                        <div class="modal-footer mt-6 text-right space-x-2">${footerHTML}</div>
                    </div>
                </div>
            `;
            DOMElements.modalContainer.innerHTML = modalHTML;
            lucide.createIcons();
            document.getElementById('modal-backdrop').addEventListener('click', (e) => {
                if (e.target.id === 'modal-backdrop' || e.target.closest('#modal-close-btn') || e.target.closest('#cancel-delete')) {
                    closeModal();
                }
            });
        };
        
        const closeModal = () => {
            DOMElements.modalContainer.innerHTML = '';
        };

        const showPage = (pageId) => {
            document.querySelectorAll('.page, .dashboard-page').forEach(p => p.classList.add('hidden'));
            if (pageId.includes('dashboard')) {
                DOMElements.dashboardContainer.classList.remove('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            } else {
                DOMElements.dashboardContainer.classList.add('hidden');
                document.getElementById(pageId).classList.remove('hidden');
            }
            state.activePage = pageId;
        };
        
        const navigateToSection = (sectionId, title) => {
            document.querySelectorAll('.dashboard-section').forEach(sec => sec.classList.add('hidden'));
            const section = document.getElementById(sectionId);
            if(section) {
                section.classList.remove('hidden');
                DOMElements.pageTitle.textContent = title;
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.classList.toggle('active', link.dataset.target === sectionId);
                });

                // --- NEW: Trigger calendar rendering on navigation ---
                if (sectionId === 'admin-holidays') {
                    renderHolidayCalendar(calendarState.holiday.year, calendarState.holiday.month);
                }
                if (sectionId === 'admin-student-calendar') {
                    // Just ensures the dropdowns are populated, user action will trigger the calendar render
                    populateSelect('calendar-class-select', state.allClasses);
                    // Clear previous views
                    document.getElementById('calendar-student-select').innerHTML = '<option value="">-- Select Class First --</option>';
                    document.getElementById('student-attendance-calendar-container').innerHTML = `<p class="text-slate-500">Please select a class and student to view their attendance calendar.</p>`;

                }

            } else {
                console.error(`Section with id ${sectionId} not found.`);
            }
             if (window.innerWidth < 768) {
                document.getElementById('sidebar')?.classList.remove('open');
                document.getElementById('sidebar-overlay')?.classList.add('hidden');
            }
        };

        const cleanupListeners = () => {
            state.unsubscribeListeners.forEach(unsub => unsub());
            state.unsubscribeListeners = [];
            if(state.clockInterval) clearInterval(state.clockInterval);
            state.clockInterval = null;
        };
        
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };

         const formatToYYYYMMDD = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        const formatTime = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        };
        
        const getTodayDateString = () => formatToYYYYMMDD(new Date());
        
        const populateSelect = (selectId, options, textKey = null, valueKey = null) => {
            const select = document.getElementById(selectId);
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Select --</option>';
            options.forEach(opt => {
                const text = textKey ? (typeof textKey === 'function' ? textKey(opt) : opt[textKey]) : opt;
                const value = valueKey ? (typeof valueKey === 'function' ? valueKey(opt) : opt[valueKey]) : opt;
                select.innerHTML += `<option value="${value}">${text}</option>`;
            });
            select.value = currentVal;
        };

        const animateValue = (el, start, end, duration) => {
            if (start === end) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                el.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        };

        const startClock = () => {
            if (state.clockInterval) clearInterval(state.clockInterval);

            const clockElPortal = document.getElementById('portal-digital-clock');

            const updateClocks = () => {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const istOffset = 5.5 * 3600000;
                const istTime = new Date(utc + istOffset);

                let hours = istTime.getHours();
                const minutes = String(istTime.getMinutes()).padStart(2, '0');
                const seconds = String(istTime.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                const hoursStr = String(hours).padStart(2, '0');

                const timeString = `${hoursStr}:${minutes}:${seconds} ${ampm}`;

                if (clockElPortal) clockElPortal.textContent = timeString;
            };

            updateClocks();
            state.clockInterval = setInterval(updateClocks, 1000);
        };


        // ===================================================================
        // ====================== DYNAMIC HTML RENDERERS =====================
        // ===================================================================
        
        const createAttendanceChart = (canvasId, presentCount, totalCount, title) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            if (state.charts[canvasId]) {
                state.charts[canvasId].destroy();
            }

            const percentage = totalCount > 0 ? (presentCount / totalCount) * 100 : 0;

            const centerTextPlugin = {
                id: 'centerText',
                afterDraw: (chart) => {
                    const { ctx, chartArea: { top, width, height } } = chart;
                    ctx.save();
                    const text = percentage.toFixed(0) + '%';
                    ctx.font = `bold ${chart.chartArea.width / 5}px Inter, sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#16a34a'; // green-600
                    
                    const centerX = width / 2;
                    const centerY = top + (height / 2);
                    
                    if(chart.data.datasets[0].data[0] === 0 && chart.data.datasets[0].data[1] === 0){
                         ctx.fillStyle = '#64748b'; // slate-500
                         ctx.font = `500 ${chart.chartArea.width / 6}px Inter, sans-serif`;
                         ctx.fillText('N/A', centerX, centerY);
                    } else {
                         ctx.fillText(text, centerX, centerY);
                    }
                    ctx.restore();
                }
            };

            state.charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [presentCount, totalCount - presentCount],
                        backgroundColor: [ '#22c55e', '#f1f5f9' ],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: {
                            display: true,
                            text: title,
                            position: 'bottom',
                            padding: { top: 10 },
                            font: { size: 12, family: 'Inter, sans-serif', weight: '500' },
                            color: '#64748b'
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    }
                },
                plugins: [centerTextPlugin]
            });
        };
        
        const renderSidebar = (role, unreadCounts = {}) => {
            const sidebarContainer = DOMElements.dashboardContainer;
            const existingSidebar = document.getElementById('sidebar');
            if (existingSidebar) existingSidebar.remove();

            const adminLinks = [
                { id: 'admin-overview', icon: 'LayoutDashboard', text: 'Overview' },
                { id: 'admin-requests', icon: 'Send', text: 'Teacher Requests', badgeKey: 'requests' },
                { id: 'admin-exams', icon: 'FilePenLine', text: 'Manage Exams' },
                { id: 'admin-attendance', icon: 'CalendarCheck', text: 'View Attendance' },
                { id: 'admin-student-calendar', icon: 'CalendarDays', text: 'Attendance Calendar' },
                { id: 'admin-holidays', icon: 'PartyPopper', text: 'Manage Holidays' },
                { id: 'admin-marks', icon: 'GraduationCap', text: 'View Marks' },
                { id: 'admin-notices', icon: 'Megaphone', text: 'Manage Notices' },
                { id: 'admin-teachers', icon: 'Users', text: 'Manage Teachers' },
                { id: 'admin-students', icon: 'Contact', text: 'Manage Students' },
                { id: 'admin-chat', icon: 'MessageSquare', text: 'Group Chat', badgeKey: 'chat' },
            ];

            const teacherLinks = [
                { id: 'teacher-overview', icon: 'LayoutDashboard', text: 'Overview' },
                { id: 'teacher-exam-request', icon: 'FilePlus', text: 'Request Exam' },
                { id: 'teacher-attendance', icon: 'CalendarPlus', text: 'Mark Attendance' },
                { id: 'teacher-marks', icon: 'ClipboardEdit', text: 'Enter Marks' },
                { id: 'teacher-analytics', icon: 'LineChart', text: 'Analytics' },
                { id: 'teacher-requests', icon: 'Send', text: 'My Requests' },
                { id: 'teacher-settings', icon: 'Settings', text: 'Settings' },
                { id: 'teacher-chat', icon: 'MessageSquare', text: 'Group Chat', badgeKey: 'chat' },
            ];

            const links = role === 'admin' ? adminLinks : teacherLinks;
            
            const userInitial = state.currentUser?.email?.charAt(0).toUpperCase() || '?';
            const userEmail = state.currentUser?.email || 'user@example.com';
            const photoURL = state.currentTeacherData?.photoURL;
            
            const avatarHTML = photoURL
                ? `<img src="${photoURL}" class="w-10 h-10 rounded-full object-cover">`
                : `<div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white">${userInitial}</div>`;


            const sidebarHTML = `
                <aside id="sidebar" class="sidebar flex flex-col h-full">
                    <div class="sidebar-logo p-4 flex items-center gap-3 border-b border-slate-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                        <span class="logo-text text-xl font-bold text-white">Adarsha Inst.</span>
                    </div>
                    <nav class="flex-grow p-2 space-y-1">
                        ${links.map(link => `
                            <a href="#" class="sidebar-link flex items-center justify-between gap-3 p-3 rounded-md" data-target="${link.id}">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="${link.icon}" class="w-5 h-5"></i>
                                    <span>${link.text}</span>
                                </div>
                                ${link.badgeKey ? `<span id="${link.badgeKey}-badge" class="badge bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>` : ''}
                            </a>
                        `).join('')}
                    </nav>
                    <div class="sidebar-footer p-3 border-t border-slate-700">
                        <div class="flex items-center gap-3">
                             <div id="sidebar-avatar-container">${avatarHTML}</div>
                            <div class="flex-grow min-w-0">
                                <p class="font-semibold text-sm text-white user-name truncate" title="${userEmail}">${userEmail}</p>
                                <p class="text-xs text-slate-400 user-role">${role.charAt(0).toUpperCase() + role.slice(1)}</p>
                            </div>
                        </div>
                    </div>
                </aside>
            `;
            
            sidebarContainer.insertAdjacentHTML('afterbegin', sidebarHTML);
            lucide.createIcons();
        };

        const renderAdminDashboardSections = () => {
             DOMElements.adminDashboard.innerHTML = `
                <div id="admin-overview" class="dashboard-section space-y-6"></div>
                <div id="admin-requests" class="dashboard-section hidden"></div>
                <div id="admin-exams" class="dashboard-section hidden"></div>
                <div id="admin-attendance" class="dashboard-section hidden"></div>
                <div id="admin-student-calendar" class="dashboard-section hidden"></div>
                <div id="admin-holidays" class="dashboard-section hidden"></div>
                <div id="admin-marks" class="dashboard-section hidden"></div>
                <div id="admin-notices" class="dashboard-section hidden"></div>
                <div id="admin-teachers" class="dashboard-section hidden"></div>
                <div id="admin-students" class="dashboard-section hidden"></div>
                <div id="admin-chat" class="dashboard-section hidden"></div>
            `;
            document.getElementById('admin-overview').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div id="total-teachers-card" class="card interactive flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors"><div class="p-3 rounded-full bg-blue-100"><i data-lucide="Users" class="w-8 h-8 text-blue-500"></i></div><div><p class="text-sm text-slate-500">Total Teachers</p><p id="total-teachers-stat" class="text-2xl font-bold">0</p></div></div>
                    <div id="total-students-card" class="card interactive flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors"><div class="p-3 rounded-full bg-green-100"><i data-lucide="Contact" class="w-8 h-8 text-green-500"></i></div><div><p class="text-sm text-slate-500">Total Students</p><p id="total-students-stat" class="text-2xl font-bold">0</p></div></div>
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-amber-100"><i data-lucide="Megaphone" class="w-8 h-8 text-amber-500"></i></div><div><p class="text-sm text-slate-500">Active Notices</p><p id="active-notices-stat" class="text-2xl font-bold">0</p></div></div>
                    <div class="card flex items-center gap-4"><div class="p-3 rounded-full bg-red-100"><i data-lucide="Send" class="w-8 h-8 text-red-500"></i></div><div><p class="text-sm text-slate-500">Pending Requests</p><p id="pending-requests-stat" class="text-2xl font-bold">0</p></div></div>
                </div>
                <div>
                    <h2 class="text-2xl font-bold mb-4 text-slate-700">Live Statistics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="card"><div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-slate-500">Today's Attendance</p><i data-lucide="BarChart3" class="w-5 h-5 text-slate-400"></i></div><p id="live-attendance-stat" class="text-3xl font-bold">0%</p></div>
                        <div class="card interactive cursor-pointer" id="ongoing-classes-card"><div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-slate-500">Ongoing Classes</p><i data-lucide="Presentation" class="w-5 h-5 text-slate-400"></i></div><p id="live-classes-stat" class="text-3xl font-bold">0</p></div>
                        <div class="card interactive cursor-pointer" id="upcoming-tests-card"><div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-slate-500">Upcoming Tests (7d)</p><i data-lucide="ClipboardList" class="w-5 h-5 text-slate-400"></i></div><p id="live-tests-stat" class="text-3xl font-bold">0</p></div>
                        <div class="card"><div class="flex justify-between items-center mb-2"><p class="text-sm font-medium text-slate-500">Recent Teacher Activity</p><i data-lucide="UserCheck" class="w-5 h-5 text-slate-400"></i></div><p id="live-teacher-activity-stat" class="text-lg font-bold truncate">N/A</p></div>
                    </div>
                </div>
            `;
            document.getElementById('admin-requests').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Teacher Requests</h2><div id="admin-requests-list" class="space-y-3 max-h-[70vh] overflow-y-auto"></div></div>`;
            document.getElementById('admin-exams').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <div class="card mb-6">
                            <h2 class="text-xl font-bold mb-4">Schedule New Exam</h2>
                            <form id="schedule-exam-form" class="space-y-4">
                                <select id="exam-class" class="input-field" required></select>
                                <input type="text" id="exam-subject" placeholder="Subject" class="input-field" required>
                                <input type="date" id="exam-date" class="input-field" required>
                                <textarea id="exam-portions" placeholder="Chapters / Portions (Optional)" class="input-field h-24"></textarea>
                                <button type="submit" class="btn-primary w-full ripple">Schedule Exam</button>
                            </form>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4">Pending Exam Requests</h2>
                            <div id="admin-exam-requests-list" class="space-y-3 max-h-[40vh] overflow-y-auto"></div>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">All Scheduled Exams</h2>
                        <div id="admin-scheduled-exams-list" class="space-y-3 max-h-[70vh] overflow-y-auto"></div>
                    </div>
                </div>
            `;
            document.getElementById('admin-attendance').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">View Attendance Records</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><input type="date" id="admin-attendance-date" class="input-field" value="${getTodayDateString()}"><select id="admin-attendance-class" class="input-field"></select><input type="text" id="admin-attendance-subject" placeholder="Subject (Optional)" class="input-field"><button id="admin-view-attendance-btn" class="btn-primary ripple">View</button></div><div id="admin-attendance-display" class="max-h-[60vh] overflow-y-auto"><p class="text-slate-500">Select filters to view attendance.</p></div></div>`;
            document.getElementById('admin-student-calendar').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Student Monthly Attendance</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><select id="calendar-class-select" class="input-field"></select><select id="calendar-student-select" class="input-field" disabled><option value="">-- Select Class First --</option></select></div><div id="student-attendance-calendar-container" class="mt-4"><p class="text-slate-500">Please select a class and student to view their attendance calendar.</p></div></div>`;
            document.getElementById('admin-holidays').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Manage Holidays</h2><p class="text-slate-500 mb-4">Click on a date to mark or unmark it as a holiday. Sundays are now treated as regular working days.</p><div id="holiday-calendar-container"></div></div>`;
            document.getElementById('admin-marks').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">View Student Marks</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><select id="admin-marks-class" class="input-field"></select><button id="admin-view-marks-btn" class="btn-primary ripple">View Marks</button></div><div id="admin-marks-display" class="max-h-[60vh] overflow-y-auto"><p class="text-slate-500">Select a class to view marks.</p></div></div>`;
            document.getElementById('admin-notices').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><div class="card"><h2 class="text-xl font-bold mb-4">Post a New Notice</h2><form id="add-notice-form" class="space-y-4"><input type="text" id="notice-title" placeholder="Notice Title" class="input-field" required><textarea id="notice-content" placeholder="Notice Content..." class="input-field h-32" required></textarea><button type="submit" class="btn-primary w-full ripple">Post Notice</button></form></div></div><div class="lg:col-span-2"><div class="card"><h2 class="text-xl font-bold mb-4">Active Notices</h2><div id="admin-notices-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div></div></div></div>`;
            document.getElementById('admin-teachers').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Add New Teacher</h2><form id="add-teacher-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><input type="text" id="new-teacher-name" placeholder="Full Name" class="input-field" required><input type="email" id="new-teacher-email" placeholder="Email" class="input-field" required><input type="password" id="new-teacher-password" placeholder="Temporary Password" class="input-field" required><div class="md:col-span-3"><button type="submit" class="btn-primary ripple">Add Teacher</button></div></form></div><div class="card"><h2 class="text-xl font-bold mb-4">Teacher List</h2><div id="teacher-list-container" class="max-h-[500px] overflow-y-auto"></div></div>`;
            document.getElementById('admin-students').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Add New Student</h2>
                <form id="add-student-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="new-student-name" placeholder="Full Name" class="input-field" required>
                        <input type="text" id="new-student-class" placeholder="Class (e.g., 10th A)" class="input-field" required>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="custom-attendance-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="custom-attendance-toggle" class="text-sm text-slate-600">Set Custom Class Attendance</label>
                    </div>
                    <div id="custom-attendance-details" class="hidden space-y-3 pt-3 border-t">
                        <div class="flex gap-4">
                           <label class="flex items-center gap-2"><input type="radio" name="attendance-type" value="only" checked> Attends ONLY</label>
                           <label class="flex items-center gap-2"><input type="radio" name="attendance-type" value="except"> Attends ALL EXCEPT</label>
                        </div>
                        <input type="text" id="custom-subjects" placeholder="Enter subjects, separated by commas..." class="input-field">
                    </div>
                    <div>
                        <button type="submit" class="btn-primary ripple">Add Student</button>
                    </div>
                </form>
            </div>
            <div class="card"><h2 class="text-xl font-bold mb-4">Student List</h2><div class="flex gap-4 mb-4"><input type="text" id="student-search-input" placeholder="Search students..." class="input-field flex-grow"><select id="student-class-filter" class="input-field w-auto"></select></div><div id="student-list-container" class="max-h-[500px] overflow-y-auto"></div></div>`;
            renderChatUI('admin-chat');
        };

        const renderTeacherDashboardSections = () => {
            DOMElements.teacherDashboard.innerHTML = `
                <div id="teacher-overview" class="dashboard-section space-y-6"></div>
                <div id="teacher-exam-request" class="dashboard-section hidden"></div>
                <div id="teacher-attendance" class="dashboard-section hidden"></div>
                <div id="teacher-marks" class="dashboard-section hidden"></div>
                <div id="teacher-analytics" class="dashboard-section hidden"></div>
                <div id="teacher-requests" class="dashboard-section hidden"></div>
                <div id="teacher-settings" class="dashboard-section hidden"></div>
                <div id="teacher-chat" class="dashboard-section hidden"></div>
            `;
            document.getElementById('teacher-overview').innerHTML = `
                <div class="card">
                    <h2 class="text-2xl font-bold">Welcome, <span id="teacher-welcome-name"></span>!</h2>
                    <p class="text-slate-500">Here's a summary of your dashboard. Click on the cards to view details.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="view-assigned-classes-card" class="card interactive flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors">
                        <div class="p-3 rounded-full bg-indigo-100">
                            <i data-lucide="BookOpenCheck" class="w-8 h-8 text-indigo-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">My Assigned Classes</p>
                            <p id="assigned-classes-count" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                     <div id="view-upcoming-exams-card" class="card interactive flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition-colors">
                        <div class="p-3 rounded-full bg-amber-100">
                            <i data-lucide="ClipboardList" class="w-8 h-8 text-amber-500"></i>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Upcoming Exams</p>
                            <p id="upcoming-exams-count" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>
                <div id="teacher-attendance-recap-card" class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-700">Today's Attendance Recap</h3>
                        <i data-lucide="CheckCircle2" class="w-5 h-5 text-slate-400"></i>
                    </div>
                    <div id="teacher-attendance-recap-list" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <p class="text-slate-500 text-sm sm:col-span-3">No classes taken yet today.</p>
                    </div>
                </div>`;
            document.getElementById('teacher-exam-request').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4">Request a New Exam</h2>
                            <form id="request-exam-form" class="space-y-4">
                                <select id="teacher-exam-class" class="input-field" required></select>
                                <select id="teacher-exam-subject" class="input-field" required></select>
                                <input type="date" id="teacher-exam-date" class="input-field" required>
                                <textarea id="teacher-exam-portions" placeholder="Chapters / Portions (Optional)" class="input-field h-32"></textarea>
                                <button type="submit" class="btn-primary w-full ripple">Submit Request</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card">
                            <h2 class="text-xl font-bold mb-4">My Exam Requests</h2>
                            <div id="teacher-exam-requests-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('teacher-attendance').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Mark Attendance</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><select id="teacher-attendance-class-subject" class="input-field"></select><input type="date" id="teacher-attendance-date" class="input-field" value="${getTodayDateString()}"><button id="teacher-load-students-btn" class="btn-primary ripple">Load Students</button></div><div id="teacher-attendance-sheet"></div></div>`;
            document.getElementById('teacher-marks').innerHTML = `<div class="card">
                <h2 class="text-xl font-bold mb-4">Enter Marks</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 items-end">
                    <div><label class="text-sm font-medium text-slate-600">Test Name</label><input type="text" id="teacher-marks-test-name" placeholder="e.g., Chapter 5 Test" class="input-field"></div>
                    <div><label class="text-sm font-medium text-slate-600">Class</label><select id="teacher-marks-class" class="input-field"></select></div>
                    <div><label class="text-sm font-medium text-slate-600">Subject</label><select id="teacher-marks-subject" class="input-field"></select></div>
                    <div><label class="text-sm font-medium text-slate-600">Max Marks</label><input type="number" id="teacher-marks-max" placeholder="e.g., 100" class="input-field"></div>
                    <div class="lg:col-span-4">
                        <button id="teacher-load-marks-sheet-btn" class="btn-primary ripple">Load Marks Sheet</button>
                    </div>
                </div>
                <div id="teacher-marks-sheet"></div>
            </div>`;
            document.getElementById('teacher-analytics').innerHTML = `<div class="card"><h2 class="text-xl font-bold mb-4">Performance Analytics</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><select id="analytics-exam-select" class="input-field"></select><select id="analytics-class-select" class="input-field"></select></div><div id="analytics-chart-container" class="mt-4"><canvas id="marks-chart"></canvas><p id="analytics-placeholder" class="text-slate-500">Select an exam and class to view analytics.</p></div></div>`;
            document.getElementById('teacher-requests').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><div class="card"><h2 class="text-xl font-bold mb-4">Submit a New Request</h2><form id="add-request-form" class="space-y-4"><input type="text" id="request-title" placeholder="Request Subject" class="input-field" required><textarea id="request-content" placeholder="Details of your request..." class="input-field h-32" required></textarea><button type="submit" class="btn-primary w-full ripple">Submit Request</button></form></div></div><div class="lg:col-span-2"><div class="card"><h2 class="text-xl font-bold mb-4">My Past Requests</h2><div id="teacher-requests-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div></div></div></div>`;
            document.getElementById('teacher-settings').innerHTML = `<div class="max-w-xl mx-auto space-y-6">
                <div class="card">
                     <h2 class="text-xl font-bold mb-4">Profile Picture</h2>
                     <div class="flex items-center gap-6">
                         <img id="profile-pic-preview" src="https://placehold.co/80x80/e0e7ff/4f46e5?text=A" class="w-20 h-20 rounded-full object-cover border-2 border-slate-200">
                         <div>
                              <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                              <button onclick="document.getElementById('profile-pic-input').click()" class="btn-primary ripple">Choose Image</button>
                              <p class="text-xs text-slate-500 mt-2">Recommended: Square image (e.g., 200x200px).</p>
                         </div>
                     </div>
                      <div id="upload-progress-container" class="mt-4 hidden">
                         <button id="upload-pic-btn" class="btn-primary ripple w-full">Upload and Save</button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Change Password</h2>
                    <form id="change-password-form" class="space-y-4">
                        <input type="password" id="current-password" placeholder="Current Password" class="input-field" required>
                        <input type="password" id="new-password" placeholder="New Password" class="input-field" required>
                        <input type="password" id="confirm-new-password" placeholder="Confirm New Password" class="input-field" required>
                        <button type="submit" class="btn-primary w-full ripple">Update Password</button>
                    </form>
                </div>
            </div>`;
            renderChatUI('teacher-chat');
        };
        
        const renderChatUI = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="card h-[70vh] flex flex-col">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 border-slate-200">Internal Group Chat</h2>
                    <div id="${containerId}-messages" class="flex-grow overflow-y-auto mb-4 p-2 space-y-4 bg-slate-50 rounded-md">
                        <!-- Messages will appear here -->
                    </div>
                    <form id="${containerId}-form" class="flex gap-2">
                        <input type="text" id="${containerId}-input" placeholder="Type your message..." class="input-field flex-grow" required>
                        <button type="submit" class="btn-primary ripple flex items-center gap-2">Send <i data-lucide="Send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            `;
            lucide.createIcons();
        };

        const showTeacherStatusModal = async () => {
            showLoading();
            try {
                const teachersQuery = query(collection(db, 'teachers'), orderBy('name'));
                const teachersSnapshot = await getDocs(teachersQuery);
                const teachers = teachersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                const todayStr = getTodayDateString();
                const attendanceQuery = query(collection(db, 'attendance'), where('date', '==', todayStr));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const todaysAttendance = attendanceSnapshot.docs.map(d => d.data());

                const attendanceByTeacher = todaysAttendance.reduce((acc, record) => {
                    const teacherId = record.teacherId;
                    if (!acc[teacherId]) acc[teacherId] = [];
                    acc[teacherId].push(record);
                    return acc;
                }, {});

                const augmentedTeachers = teachers.map(teacher => {
                    const teacherRecords = attendanceByTeacher[teacher.id] || [];
                    const sessions = teacherRecords.reduce((acc, record) => {
                        const key = `${record.class}|${record.subject}`;
                        if (!acc[key]) {
                            acc[key] = { present: 0, total: 0, className: record.class, subject: record.subject, timestamp: record.timestamp };
                        }
                        acc[key].total++;
                        if (record.status === 'present') acc[key].present++;
                        if (!acc[key].timestamp || record.timestamp.toMillis() > acc[key].timestamp.toMillis()) {
                           acc[key].timestamp = record.timestamp;
                        }
                        return acc;
                    }, {});
                    const lastThreeSessions = Object.values(sessions)
                        .sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis())
                        .slice(0, 3);
                    return { ...teacher, lastThreeSessions };
                });

                const contentHTML = `
                    <div class="max-h-[70vh] overflow-y-auto pr-2">
                        <ul class="space-y-4">
                            ${augmentedTeachers.map(teacher => {
                                const statusData = state.teacherStatuses[teacher.id];
                                const isOnline = statusData && statusData.state === 'online';
                                const statusIndicator = isOnline
                                    ? `<div class="flex items-center gap-2 text-green-600"><div class="w-2.5 h-2.5 bg-green-500 rounded-full"></div><span>Online</span></div>`
                                    : `<div class="flex items-center gap-2 text-slate-500"><div class="w-2.5 h-2.5 bg-slate-400 rounded-full"></div><span>Offline</span></div>`;
                                const avatar = teacher.photoURL
                                    ? `<img src="${teacher.photoURL}" class="w-10 h-10 rounded-full object-cover">`
                                    : `<div class="w-10 h-10 rounded-full bg-indigo-200 text-indigo-700 flex items-center justify-center font-bold">${teacher.name.charAt(0)}</div>`;

                                return `
                                    <li class="p-4 rounded-md bg-slate-50 border">
                                        <div class="flex items-center justify-between">
                                             <div class="flex items-center gap-3">
                                                 ${avatar}
                                                 <div>
                                                     <p class="font-medium text-slate-800">${teacher.name}</p>
                                                     <p class="text-sm text-slate-500">${teacher.email}</p>
                                                 </div>
                                             </div>
                                            ${statusIndicator}
                                        </div>
                                        <div class="border-t my-3"></div>
                                        <div>
                                            <p class="text-xs font-semibold text-slate-400 mb-2 uppercase">Recent Attendance</p>
                                            ${teacher.lastThreeSessions.length > 0
                                                ? `<div class="grid grid-cols-3 gap-4">
                                                   ${teacher.lastThreeSessions.map((session, index) => `
                                                       <div class="text-center">
                                                           <div class="w-20 h-20 mx-auto">
                                                               <canvas id="admin-teacher-chart-${teacher.id}-${index}"></canvas>
                                                           </div>
                                                       </div>
                                                   `).join('')}
                                                   </div>`
                                                : '<p class="text-slate-500 text-sm">No classes taken yet today.</p>'
                                            }
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    </div>
                `;

                showModal('Teacher Status & Activity', contentHTML, `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);

                augmentedTeachers.forEach(teacher => {
                    teacher.lastThreeSessions.forEach((session, index) => {
                        const canvasId = `admin-teacher-chart-${teacher.id}-${index}`;
                        const title = `${session.className} - ${session.subject}`;
                        createAttendanceChart(canvasId, session.present, session.total, title);
                    });
                });

            } catch (error) {
                console.error("Error fetching teachers for status modal:", error);
                showToast("Could not load teacher statuses.", "error");
            } finally {
                hideLoading();
            }
        };

        const showStudentListModal = async () => {
            showLoading();
            try {
                // Time Check Logic
                const now = new Date();
                const day = now.getDay(); // 0 = Sunday, 6 = Saturday
                const hour = now.getHours();
                const minute = now.getMinutes();
                let isLiveTime = false;

                if (day === 0) { // Sunday
                    // Live during the morning/day until 5:30 PM
                    if (hour < 17 || (hour === 17 && minute < 30)) {
                        isLiveTime = true;
                    }
                } else { // Monday to Saturday
                    const currentTimeInMinutes = hour * 60 + minute;
                    const startTimeInMinutes = 17 * 60 + 30; // 5:30 PM
                    const endTimeInMinutes = 20 * 60 + 30; // 8:30 PM
                    if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes) {
                        isLiveTime = true;
                    }
                }

                if (!isLiveTime) {
                    const messageHTML = `
                        <div class="text-center p-4">
                            <i data-lucide="Clock" class="w-12 h-12 mx-auto text-amber-500 mb-4"></i>
                            <p class="font-semibold text-slate-700">Live Status Unavailable</p>
                            <p class="text-sm text-slate-500 mt-2">
                                Live student attendance is only shown during scheduled class hours:
                            </p>
                            <ul class="text-sm text-slate-500 mt-2 list-disc list-inside">
                                <li><strong>Mon - Sat:</strong> 5:30 PM - 8:30 PM IST</li>
                                <li><strong>Sunday:</strong> Morning hours</li>
                            </ul>
                            <p class="text-sm text-slate-500 mt-3">Please check back during these times.</p>
                        </div>
                    `;
                    showModal('Student Status', messageHTML, `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);
                    hideLoading();
                    return;
                }
                
                if (state.allStudents.length === 0) {
                    showModal('All Students', '<p class="text-slate-500">No students found.</p>', `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);
                    hideLoading();
                    return;
                }

                const todayStr = getTodayDateString();
                const attendanceQuery = query(collection(db, 'attendance'), where('date', '==', todayStr));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const todaysAttendance = {};
                attendanceSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!todaysAttendance[data.studentId]) {
                        todaysAttendance[data.studentId] = [];
                    }
                    todaysAttendance[data.studentId].push({ subject: data.subject, status: data.status });
                });

                const studentsByClass = state.allStudents.reduce((acc, student) => {
                    const className = student.class || 'No Class Assigned';
                    if (!acc[className]) {
                        acc[className] = [];
                    }
                    acc[className].push(student);
                    return acc;
                }, {});

                const sortedClasses = Object.keys(studentsByClass).sort();

                const contentHTML = `
                    <div class="max-h-[70vh] overflow-y-auto pr-2">
                        ${sortedClasses.map(className => `
                            <div class="mb-4">
                                <h3 class="font-bold text-lg p-2 bg-slate-100 rounded-md sticky top-0">${className}</h3>
                                <ul class="space-y-2 mt-2">
                                    ${studentsByClass[className].map(student => {
                                        const studentAttendance = todaysAttendance[student.id];
                                        let statusHTML = '<span class="text-xs text-slate-400">Not Marked</span>';
                                        if (studentAttendance) {
                                            statusHTML = studentAttendance.map(att => {
                                                const color = att.status === 'present' ? 'bg-green-500' : 'bg-red-500';
                                                return `<span class="inline-flex items-center gap-1.5 mr-2" title="${att.subject}">
                                                            <div class="w-2.5 h-2.5 ${color} rounded-full"></div>
                                                            <span class="text-xs text-slate-600">${att.subject}</span>
                                                        </span>`;
                                            }).join('');
                                        }
                                        const customTag = student.customAttendance ? `<span class="text-xs bg-purple-100 text-purple-700 font-medium px-2 py-1 rounded-full">Custom Schedule</span>` : '';

                                        return `
                                            <li class="p-3 rounded-md bg-slate-50 flex justify-between items-center">
                                                <div class="flex items-center gap-2">
                                                    <p class="font-medium text-slate-800">${student.name}</p>
                                                    ${customTag}
                                                </div>
                                                <div class="flex items-center gap-2">${statusHTML}</div>
                                            </li>
                                        `;
                                    }).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                `;

                showModal('Student Attendance Status - Today', contentHTML, `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);

            } catch (error) {
                console.error("Error fetching students for list modal:", error);
                showToast("Could not load student list.", "error");
            } finally {
                hideLoading();
            }
        };
        
        const showAssignedClassesModal = () => {
            if (!state.currentTeacherData || !state.currentTeacherData.assignedClasses) {
                showToast("No assigned classes found.", "info");
                return;
            }

            const assignedClasses = state.currentTeacherData.assignedClasses;

            if (assignedClasses.length === 0) {
                showModal('Assigned Classes', '<p class="text-slate-500">You have not been assigned any classes yet.</p>', `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);
                return;
            }

            const contentHTML = `
                <div class="max-h-[60vh] overflow-y-auto pr-2">
                    <ul class="space-y-3">
                        ${assignedClasses.map(c => `
                            <li class="flex items-center justify-between p-3 rounded-md bg-slate-50">
                                <p class="font-medium text-slate-800">${c.class}</p>
                                <p class="text-sm text-slate-600">${c.subject}</p>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            showModal('My Assigned Classes', contentHTML, `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);
        };


        // ===================================================================
        // =================== CALENDAR & HOLIDAY FUNCTIONS ==================
        // ===================================================================

        const calendarState = {
            holiday: { year: new Date().getFullYear(), month: new Date().getMonth() },
            student: { year: new Date().getFullYear(), month: new Date().getMonth() },
            holidays: new Set(), // Store 'YYYY-MM-DD' strings
        };

        const fetchHolidaysForMonth = async (year, month) => {
            try {
                calendarState.holidays.clear();
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0);
                const startStr = formatToYYYYMMDD(startDate);
                const endStr = formatToYYYYMMDD(endDate);

                const holidaysQuery = query(collection(db, 'holidays'), where('date', '>=', startStr), where('date', '<=', endStr));
                const snapshot = await getDocs(holidaysQuery);
                snapshot.forEach(doc => calendarState.holidays.add(doc.id));
            } catch (error) {
                console.error("Error fetching holidays:", error);
                // Rethrow the error so the calling function's catch block can handle UI changes.
                throw error;
            }
        };
        
        const renderHolidayCalendar = async (year, month) => {
            const container = document.getElementById('holiday-calendar-container');
            if (!container) return;
            showLoading();

            try {
                await fetchHolidaysForMonth(year, month);

                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const firstDay = new Date(year, month).getDay();
                const daysInMonth = 32 - new Date(year, month, 32).getDate();

                let table = `<div class="flex items-center justify-between mb-4">
                                <button id="prev-holiday-month" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="ChevronLeft" class="pointer-events-none"></i></button>
                                <h3 class="text-lg font-bold">${monthNames[month]} ${year}</h3>
                                <button id="next-holiday-month" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="ChevronRight" class="pointer-events-none"></i></button>
                             </div>
                             <div class="grid grid-cols-7 gap-1 text-center font-semibold text-slate-500 text-sm mb-2">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                             </div>
                             <div class="grid grid-cols-7 gap-1">`;

                for (let i = 0; i < firstDay; i++) {
                    table += '<div></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const currentDate = new Date(year, month, i);
                    const dateStr = formatToYYYYMMDD(currentDate);
                    const isHoliday = calendarState.holidays.has(dateStr);
                    const isToday = formatToYYYYMMDD(new Date()) === dateStr;

                    let cellClass = 'h-12 flex items-center justify-center rounded-lg cursor-pointer transition-colors';
                    
                    if (isHoliday) {
                        cellClass += ' bg-sky-500 text-white font-bold hover:bg-sky-600';
                    } else {
                        cellClass += ' bg-slate-50 hover:bg-slate-200';
                    }
                    if (isToday) {
                        cellClass += ' ring-2 ring-indigo-500';
                    }

                    table += `<div class="${cellClass}" data-date="${dateStr}">${i}</div>`;
                }

                table += '</div>';
                container.innerHTML = table;
                lucide.createIcons();
            } catch (error) {
                console.error("Error rendering holiday calendar:", error);
                showToast("Failed to load holiday calendar.", "error");
                container.innerHTML = `<p class="text-red-500 text-center">Could not load calendar.</p>`;
            } finally {
                hideLoading();
            }
        };

        const renderStudentAttendanceCalendar = async (studentId, year, month) => {
            const container = document.getElementById('student-attendance-calendar-container');
            if (!container) return;
            showLoading();

            try {
                // 1. Fetch holidays for the current month view
                await fetchHolidaysForMonth(year, month);

                // 2. Fetch all attendance for the student and filter client-side.
                const attendanceQuery = query(collection(db, 'attendance'), where('studentId', '==', studentId));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const attendanceByDate = {}; // { 'YYYY-MM-DD': 'present' or 'absent' }

                const monthStartStr = formatToYYYYMMDD(new Date(year, month, 1));
                const monthEndStr = formatToYYYYMMDD(new Date(year, month + 1, 0));

                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const recordDateStr = record.date;
                    if (recordDateStr >= monthStartStr && recordDateStr <= monthEndStr) {
                        if (attendanceByDate[recordDateStr] !== 'present') {
                            attendanceByDate[recordDateStr] = record.status;
                        }
                    }
                });

                // 3. Calculate Attendance Percentage
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let workingDays = 0;
                let presentDays = 0;
                const today = new Date();
                today.setHours(23, 59, 59, 999); 

                for (let i = 1; i <= daysInMonth; i++) {
                    const currentDate = new Date(year, month, i);
                    if (currentDate > today) continue; 

                    const dateStr = formatToYYYYMMDD(currentDate);
                    const isHoliday = calendarState.holidays.has(dateStr);

                    if (!isHoliday) {
                        workingDays++;
                        if (attendanceByDate[dateStr] === 'present') {
                            presentDays++;
                        }
                    }
                }

                const attendancePercentage = workingDays > 0 ? ((presentDays / workingDays) * 100).toFixed(0) : 0;


                // 4. Render Calendar
                const student = state.allStudents.find(s => s.id === studentId);

                let table = `<h3 class="text-lg font-bold text-center mb-2">Attendance for ${student?.name || 'Student'}</h3>
                             <div class="text-center mb-4 p-3 bg-slate-50 rounded-lg">
                                 <p class="text-sm font-medium text-slate-500">Monthly Attendance Rate (Working Days)</p>
                                 <p class="text-3xl font-bold text-indigo-600">${attendancePercentage}%</p>
                                 <div class="w-full bg-slate-200 rounded-full h-2.5 mt-1">
                                    <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${attendancePercentage}%"></div>
                                 </div>
                             </div>
                             <div class="flex items-center justify-between mb-4">
                                <button id="prev-student-month" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="ChevronLeft" class="pointer-events-none"></i></button>
                                <h3 class="text-lg font-bold">${monthNames[month]} ${year}</h3>
                                <button id="next-student-month" class="p-2 rounded-full hover:bg-slate-200"><i data-lucide="ChevronRight" class="pointer-events-none"></i></button>
                             </div>
                             <div class="grid grid-cols-7 gap-1 text-center font-semibold text-slate-500 text-sm mb-2">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                             </div>
                             <div class="grid grid-cols-7 gap-2">`;

                for (let i = 0; i < firstDay; i++) { table += '<div></div>'; }

                for (let i = 1; i <= daysInMonth; i++) {
                    const currentDate = new Date(year, month, i);
                    const dateStr = formatToYYYYMMDD(currentDate);
                    const isHoliday = calendarState.holidays.has(dateStr);
                    const isFuture = new Date(year, month, i, 23, 59, 59) > new Date();

                    let cellClass = 'h-16 flex items-center justify-center rounded-lg relative text-center leading-tight p-1';
                    let content = i;

                    if (isFuture) {
                        cellClass += ' bg-slate-50 text-slate-300';
                    } else if (isHoliday) {
                        cellClass += ' bg-sky-100 text-sky-700 font-medium';
                        content += '<span class="absolute bottom-1.5 text-[10px] font-semibold">Holiday</span>';
                    } else { // It's a past, working day
                        const status = attendanceByDate[dateStr];
                        if (status === 'present') {
                            cellClass += ' bg-green-100 text-green-800';
                            content = `<div class="flex flex-col items-center justify-center"><i data-lucide="Check" class="w-5 h-5 text-green-600"></i><span class="font-bold mt-1">${i}</span></div>`;
                        } else { // Absent (not present on any record for this day)
                            cellClass += ' bg-red-100 text-red-800';
                            content = `<div class="flex flex-col items-center justify-center"><i data-lucide="X" class="w-5 h-5 text-red-600"></i><span class="font-bold mt-1">${i}</span></div>`;
                        }
                    }
                    table += `<div class="${cellClass}">${content}</div>`;
                }

                table += `</div>
                          <div class="flex flex-wrap justify-end gap-x-4 gap-y-2 mt-4 text-sm">
                            <span class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-green-100 border border-green-200"></div> Present</span>
                            <span class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-red-100 border border-red-200"></div> Absent</span>
                            <span class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-sky-100 border border-sky-200"></div> Holiday</span>
                          </div>`;

                container.innerHTML = table;
                lucide.createIcons();

            } catch (error) {
                console.error("Error rendering student attendance calendar:", error);
                showToast("Failed to load student calendar.", "error");
                container.innerHTML = `<p class="text-red-500 text-center">Could not load calendar.</p>`;
            } finally {
                hideLoading();
            }
        };

        // ===================================================================
        // ======================= DATA FUNCTIONS ============================
        // ===================================================================

        const loadAttendanceSheet = async (className, subject, date) => {
            showLoading();
            const sheetContainer = document.getElementById('teacher-attendance-sheet');
            try {
                const studentsQuery = query(collection(db, 'students'), where('class', '==', className));
                const studentsSnapshot = await getDocs(studentsQuery);
                let classStudents = studentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                // Filter students based on custom attendance rules
                classStudents = classStudents.filter(student => {
                    if (student.customAttendance) {
                        const subjectList = student.attendanceSubjects.map(s => s.toLowerCase());
                        const currentSubject = subject.toLowerCase();
                        if (student.attendanceType === 'only') {
                            return subjectList.includes(currentSubject);
                        }
                        if (student.attendanceType === 'except') {
                            return !subjectList.includes(currentSubject);
                        }
                    }
                    return true; // Default: show student if no custom rules
                }).sort((a, b) => a.name.localeCompare(b.name));

                if (classStudents.length === 0) {
                    sheetContainer.innerHTML = '<p class="text-slate-500">No students found for this class and subject combination.</p>';
                    hideLoading();
                    return;
                }

                const attendanceQuery = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className), where('subject', '==', subject));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const existingAttendance = {};
                attendanceSnapshot.forEach(doc => {
                    existingAttendance[doc.data().studentId] = doc.data().status;
                });

                sheetContainer.innerHTML = `
                    <h3 class="text-lg font-bold mt-4 mb-2">Attendance for ${className} - ${subject} on ${date}</h3>
                    <div class="max-h-[50vh] overflow-y-auto">
                         <table class="w-full text-sm">
                             <thead class="bg-slate-50 text-left sticky top-0">
                                 <tr><th class="p-2">Name</th><th class="p-2 text-center">Status</th></tr>
                             </thead>
                             <tbody id="attendance-tbody">
                            ${classStudents.map(student => `
                                 <tr class="border-b border-slate-200" data-student-id="${student.id}" data-student-name="${student.name}">
                                     <td class="p-2 font-medium">${student.name}</td>
                                     <td class="p-2 text-center">
                                         <label class="mr-2"><input type="radio" name="status-${student.id}" value="present" ${existingAttendance[student.id] === 'present' || !existingAttendance[student.id] ? 'checked' : ''} required> Present</label>
                                         <label><input type="radio" name="status-${student.id}" value="absent" ${existingAttendance[student.id] === 'absent' ? 'checked' : ''}> Absent</label>
                                     </td>
                                 </tr>
                            `).join('')}
                             </tbody>
                         </table>
                    </div>
                    <div class="mt-4 flex justify-end gap-2"><button id="save-attendance-btn" class="btn-primary ripple">Save Attendance</button></div>
                `;
            } catch (error) {
                console.error("Error loading attendance sheet: ", error);
                showToast("Failed to load attendance sheet.", "error");
                sheetContainer.innerHTML = '<p class="text-red-500">Could not load student data.</p>';
            } finally {
                hideLoading();
            }
        };

        const loadMarksSheet = async (testName, className, subject, maxMarks) => {
            showLoading();
            const sheetContainer = document.getElementById('teacher-marks-sheet');
            try {
                const studentsQuery = query(collection(db, 'students'), where('class', '==', className));
                const studentsSnapshot = await getDocs(studentsQuery);
                const classStudents = studentsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));

                if (classStudents.length === 0) {
                    sheetContainer.innerHTML = '<p class="text-slate-500">No students found in this class.</p>';
                    return;
                }
                
                const marksQuery = query(collection(db, 'marks'), where('testName', '==', testName), where('class', '==', className), where('subject', '==', subject));
                const marksSnapshot = await getDocs(marksQuery);
                const existingMarks = {};
                marksSnapshot.forEach(doc => {
                    existingMarks[doc.data().studentId] = doc.data().marks;
                });

                sheetContainer.innerHTML = `
                    <h3 class="text-lg font-bold mt-4 mb-2">Enter Marks for ${testName} (${subject}) - Class ${className} (Max: ${maxMarks})</h3>
                     <div class="max-h-[50vh] overflow-y-auto">
                         <table class="w-full text-sm">
                             <thead class="bg-slate-50 text-left sticky top-0">
                                 <tr><th class="p-2">Name</th><th class="p-2">Marks</th></tr>
                             </thead>
                             <tbody id="marks-tbody">
                            ${classStudents.map(student => `
                                 <tr class="border-b border-slate-200" data-student-id="${student.id}" data-student-name="${student.name}">
                                     <td class="p-2 font-medium">${student.name}</td>
                                     <td class="p-2"><input type="number" class="input-field" placeholder="0 - ${maxMarks}" value="${existingMarks[student.id] || ''}" max="${maxMarks}" min="0"></td>
                                 </tr>
                            `).join('')}
                             </tbody>
                         </table>
                    </div>
                    <div class="mt-4 flex justify-end gap-2"><button id="save-marks-btn" class="btn-primary ripple">Save Marks</button></div>
                `;
            } catch (error) {
                console.error("Error loading marks sheet: ", error);
                showToast("Failed to load marks sheet.", "error");
            } finally {
                hideLoading();
            }
        };

        const viewAdminAttendanceRecords = async (date, className, subject) => {
            showLoading();
            const display = document.getElementById('admin-attendance-display');
            try {
                let q;
                if (subject) {
                    q = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className), where('subject', '==', subject));
                } else {
                    q = query(collection(db, 'attendance'), where('date', '==', date), where('class', '==', className));
                }
                
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    display.innerHTML = `<p class="text-slate-500">No attendance records found for the selected criteria.</p>`;
                    return;
                }

                const attendanceData = snapshot.docs.map(d => d.data()).sort((a,b) => a.studentName.localeCompare(b.studentName));
                
                display.innerHTML = `
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-2 text-left">Student Name</th>
                                <th class="p-2 text-left">Status</th>
                                <th class="p-2 text-left">Subject</th>
                                <th class="p-2 text-left">Marked By</th>
                                <th class="p-2 text-left">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attendanceData.map(a => `
                                <tr class="border-b border-slate-200">
                                    <td class="p-2 font-medium">${a.studentName}</td>
                                    <td class="p-2">
                                        <span class="${a.status === 'present' ? 'text-green-600' : 'text-red-600'} font-semibold">${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</span>
                                    </td>
                                    <td class="p-2">${a.subject}</td>
                                    <td class="p-2">${a.teacherName}</td>
                                    <td class="p-2">${formatDate(a.timestamp)} ${formatTime(a.timestamp)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error("Error fetching attendance records:", error);
                display.innerHTML = `<p class="text-red-500">Could not fetch attendance data.</p>`;
            } finally {
                hideLoading();
            }
        };

        const viewAdminMarks = async (className) => {
            showLoading();
            const display = document.getElementById('admin-marks-display');
            try {
                const q = query(collection(db, 'marks'), where('class', '==', className));
                const snapshot = await getDocs(q);
                
                const marksData = snapshot.docs.map(d => d.data());
                
                const marksByTest = marksData.reduce((acc, mark) => {
                    const test = mark.testName || 'Unnamed Test';
                    if (!acc[test]) {
                        acc[test] = {};
                    }
                    const subject = mark.subject || 'General';
                    if (!acc[test][subject]) {
                        acc[test][subject] = { maxMarks: mark.maxMarks, marks: [] };
                    }
                    acc[test][subject].marks.push(mark);
                    acc[test][subject].marks.sort((a,b) => a.studentName.localeCompare(b.studentName));
                    return acc;
                }, {});

                if (Object.keys(marksByTest).length === 0) {
                    display.innerHTML = `<p class="text-slate-500">Marks have not been published for Class ${className} yet.</p>`;
                    return;
                }

                display.innerHTML = Object.entries(marksByTest).map(([testName, subjects]) => `
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 p-2 bg-slate-100 rounded-md">${testName}</h3>
                        ${Object.entries(subjects).map(([subject, data]) => `
                            <div class="mb-6 ml-4">
                                <h4 class="font-bold text-lg mb-2">${subject} (Out of ${data.maxMarks || 'N/A'})</h4>
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50">
                                        <tr><th class="p-2 text-left">Student Name</th><th class="p-2 text-left">Marks Obtained</th></tr>
                                    </thead>
                                    <tbody>
                                        ${data.marks.map(m => `
                                            <tr class="border-b border-slate-200">
                                                <td class="p-2 font-medium">${m.studentName}</td>
                                                <td class="p-2">${m.marks}</td>
                                            </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>
                `).join('');

            } catch (error) {
                console.error("Error fetching marks:", error);
                display.innerHTML = `<p class="text-red-500">Could not fetch marks data.</p>`;
            } finally {
                hideLoading();
            }
        };
        
        // ===================================================================
        // ======================= AUTHENTICATION ==========================
        // ===================================================================
        const handleLogin = async (email, password, role) => {
            showLoading();
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === role) {
                    if (role === 'teacher') {
                        const teacherDoc = await getDoc(doc(db, 'teachers', user.uid));
                        if (teacherDoc.exists()) {
                            const teacherData = teacherDoc.data();
                             await setDoc(doc(db, 'status', user.uid), {
                                state: 'online',
                                last_changed: serverTimestamp(),
                                teacherName: teacherData.name,
                                teacherEmail: teacherData.email
                            });
                        }
                    }
                    state.currentUser = user;
                    state.userRole = userDocSnap.data().role;
                    initializeAppUI(state.userRole);
                    showToast('Login successful!', 'success');
                } else {
                    await signOut(auth);
                    showToast(`You are not authorized to access this dashboard.`, 'error');
                }
            } catch (error) {
                let errorMessage = "Incorrect email or password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    errorMessage = "No account found with that email address.";
                }
                showToast(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        };

        const handleLogout = async () => {
            showLoading();
            try {
                if (state.currentUser && state.userRole === 'teacher') {
                    await setDoc(doc(db, 'status', state.currentUser.uid), {
                        state: 'offline',
                        last_changed: serverTimestamp()
                    }, { merge: true });
                }
                await signOut(auth);
                // The onAuthStateChanged listener will now handle all UI changes and toast notifications.
            } catch (error) {
                console.error("Logout Error: ", error);
                showToast("Logout failed. Please try again.", "error");
                hideLoading(); // Hide loading only if there's an error
            }
        };

        onAuthStateChanged(auth, async (user) => {
            const wasLoggedIn = !!state.currentUser; // Check if user was logged in before this state change
            showLoading();
            cleanupListeners();
            if (user) {
                 const userDocRef = doc(db, 'users', user.uid);
                 const userDocSnap = await getDoc(userDocRef);
                 if (userDocSnap.exists()) {
                    state.currentUser = user;
                    state.userRole = userDocSnap.data().role;
                    initializeAppUI(state.userRole);
                 } else { 
                    await signOut(auth);
                    showPage('login-page');
                 }
            } else { 
                state.currentUser = null;
                state.userRole = null;
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.remove();
                showPage('student-portal');
                initializeStudentPortal();
                if(wasLoggedIn){
                    showToast('Logged out successfully.', 'success');
                }
            }
            hideLoading();
        });
        
        // ===================================================================
        // ======================= FIRESTORE ACTIONS =========================
        // ===================================================================
        
        const getSecondaryApp = () => {
            const secondaryAppName = 'Secondary';
            const existingApp = getApps().find(app => app.name === secondaryAppName);
            return existingApp || initializeApp(firebaseConfig, secondaryAppName);
        };
        
        const addTeacher = async (name, email, password) => {
            showLoading();
            let tempAuth;
            try {
                const secondaryApp = getSecondaryApp();
                tempAuth = getAuth(secondaryApp);
                const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                const user = userCredential.user;
                
                await setDoc(doc(db, 'users', user.uid), { role: 'teacher' });
                await setDoc(doc(db, 'teachers', user.uid), { name, email, uid: user.uid, assignedClasses: [] });
                
                showToast('Teacher added successfully!', 'success');
                document.getElementById('add-teacher-form').reset();
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showToast('This email address is already in use.', 'error');
                else showToast(error.message, 'error');
            } finally {
                if (tempAuth) await signOut(tempAuth);
                hideLoading();
            }
        };
        
        const deleteTeacher = (teacherId) => {
            showModal(
                'Confirm Deletion',
                `<p>Are you sure? This action will delete the teacher's data from Firestore.</p>
                 <p class="text-sm text-slate-500 mt-2">Note: For security, their login account must be deleted manually from the Firebase Authentication console.</p>`,
                `<button id="cancel-delete" class="px-4 py-2 rounded-md hover:bg-slate-100">Cancel</button>
                 <button id="confirm-delete-teacher" class="btn-primary ripple bg-red-600 hover:bg-red-700">Delete Teacher Data</button>`
            );

            document.getElementById('confirm-delete-teacher').onclick = async () => {
                closeModal();
                showLoading();
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(db, 'teachers', teacherId));
                    batch.delete(doc(db, 'users', teacherId));
                    // Also delete their status
                    batch.delete(doc(db, 'status', teacherId));
                    await batch.commit();
                    showToast('Teacher data deleted from Firestore.', 'success');
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            };
        };

        const addStudent = async (name, studentClass) => {
            showLoading();
            try {
                const studentData = {
                    name,
                    class: studentClass,
                    createdAt: serverTimestamp(),
                    customAttendance: document.getElementById('custom-attendance-toggle').checked
                };

                if (studentData.customAttendance) {
                    studentData.attendanceType = document.querySelector('input[name="attendance-type"]:checked').value;
                    const subjectsStr = document.getElementById('custom-subjects').value;
                    studentData.attendanceSubjects = subjectsStr.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                    if(studentData.attendanceSubjects.length === 0) {
                        showToast('Please enter at least one subject for custom attendance.', 'error');
                        hideLoading();
                        return;
                    }
                }

                await addDoc(collection(db, 'students'), studentData);
                showToast('Student added successfully!', 'success');
                document.getElementById('add-student-form').reset();
                document.getElementById('custom-attendance-details').classList.add('hidden');

            } catch (error) {
                console.error("Error adding student:", error);
                showToast('Failed to add student.', 'error');
            } finally {
                hideLoading();
            }
        };
        
        const deleteStudent = (studentId) => {
            showModal(
                'Confirm Deletion',
                '<p>Are you sure you want to delete this student? This action cannot be undone.</p>',
                `<button id="cancel-delete" class="px-4 py-2 rounded-md hover:bg-slate-100">Cancel</button>
                 <button id="confirm-delete-student" class="btn-primary ripple bg-red-600 hover:bg-red-700">Delete Student</button>`
            );

            document.getElementById('confirm-delete-student').onclick = async () => {
                closeModal();
                showLoading();
                try {
                    await deleteDoc(doc(db, "students", studentId));
                    showToast("Student deleted successfully.", "success");
                } catch (error) {
                    showToast("Failed to delete student.", "error");
                } finally {
                    hideLoading();
                }
            };
        };

        // ===================================================================
        // ======================= LISTENER SETUP ============================
        // ===================================================================
        
        const setupLiveStatistics = () => {
            // Live Attendance
            const todayStr = getTodayDateString();
            const attendanceQuery = query(collection(db, 'attendance'), where('date', '==', todayStr));
            const unsubAttendance = onSnapshot(attendanceQuery, async (snap) => {
                const el = document.getElementById('live-attendance-stat');
                if(!el) return;
                const totalRecords = snap.size;
                const presentRecords = snap.docs.filter(d => d.data().status === 'present').length;
                const percentage = totalRecords > 0 ? ((presentRecords / totalRecords) * 100).toFixed(1) : '0.0';
                el.textContent = `${percentage}%`;
            });

            // Ongoing Classes (simple estimation)
             const unsubOngoingClasses = onSnapshot(query(collection(db, 'status'), where('state', '==', 'online')), (snap) => {
                const el = document.getElementById('live-classes-stat');
                if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, snap.size, 1000);
                }
            });
            
            // Upcoming Tests
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const testsQuery = query(collection(db, 'exams'), where('date', '>=', Timestamp.fromDate(today)), where('date', '<=', Timestamp.fromDate(nextWeek)));
            const unsubTests = onSnapshot(testsQuery, (snap) => {
                 const el = document.getElementById('live-tests-stat');
                 if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, snap.size, 1000);
                 }
            });

            // Recent Teacher Activity
            const activityQuery = query(collection(db, 'status'), orderBy('last_changed', 'desc'), limit(1));
            const unsubActivity = onSnapshot(activityQuery, (snap) => {
                const el = document.getElementById('live-teacher-activity-stat');
                if (!el) return;
                if (!snap.empty) {
                    const latest = snap.docs[0].data();
                    el.textContent = latest.teacherName || latest.teacherEmail;
                } else {
                    el.textContent = 'No activity';
                }
            });

            state.unsubscribeListeners.push(unsubAttendance, unsubOngoingClasses, unsubTests, unsubActivity);
        };

        const setupAdminListeners = () => {
            setupLiveStatistics();
            attachAdminCalendarListeners();
            const unsubT = onSnapshot(collection(db, 'teachers'), s => {
                const el = document.getElementById('total-teachers-stat');
                if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, s.size, 1000);
                }
            });
            const unsubS = onSnapshot(collection(db, 'students'), s => {
                 const el = document.getElementById('total-students-stat');
                if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, s.size, 1000);
                }
            });
            const unsubN = onSnapshot(collection(db, 'notices'), s => {
                const el = document.getElementById('active-notices-stat');
                if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, s.size, 1000);
                }
            });
            const unsubR = onSnapshot(query(collection(db, 'requests'), where('status', '==', 'pending')), s => {
                const badge = document.getElementById('requests-badge');
                if(badge) {
                    badge.textContent = s.size;
                    badge.classList.toggle('hidden', s.size === 0);
                }
                const el = document.getElementById('pending-requests-stat');
                 if (el) {
                    const startValue = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
                    animateValue(el, startValue, s.size, 1000);
                }
            });
            const unsubNoticesList = onSnapshot(query(collection(db, 'notices'), orderBy('timestamp', 'desc')), snap => {
                const cont = document.getElementById('admin-notices-list');
                if(!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">No active notices.</p>'; return; }
                cont.innerHTML = snap.docs.map(d => `<div class="p-3 rounded-md bg-slate-50 flex justify-between items-start"><div><h3 class="font-semibold">${d.data().title}</h3><p class="text-sm text-slate-500">${d.data().content}</p><p class="text-xs text-slate-400 mt-1">${formatDate(d.data().timestamp)}</p></div><button class="delete-notice-btn p-1 text-red-500 hover:bg-red-100 rounded-full" data-id="${d.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></div>`).join('');
                lucide.createIcons();
            });

            // Listen to teacher statuses
            const unsubStatuses = onSnapshot(collection(db, 'status'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    state.teacherStatuses[change.doc.id] = change.doc.data();
                });
            });

            const renderManageTeachersTable = () => {
                const cont = document.getElementById('teacher-list-container');
                if(!cont) return;

                 getDocs(query(collection(db, 'teachers'), orderBy('name'))).then(snap => {
                      if(snap.empty){ cont.innerHTML = '<p class="text-slate-500">No teachers found.</p>'; return; }
                      cont.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50 text-left"><tr class="border-b border-slate-200"><th class="p-2">Name</th><th class="p-2">Email</th><th class="p-2">Assigned Classes</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>${snap.docs.map(d => {
                          const t = d.data();
                          return `<tr class="border-b border-slate-200"><td class="p-2 font-medium">${t.name}</td><td class="p-2">${t.email}</td><td class="p-2">${t.assignedClasses.map(c => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${c.class} (${c.subject})</span>`).join('') || 'None'}</td><td class="p-2 text-center"><button class="edit-teacher-btn text-blue-500 p-1" data-id="${d.id}"><i data-lucide="Edit" class="w-4 h-4 pointer-events-none"></i></button><button class="assign-class-btn text-green-500 p-1" data-id="${d.id}" data-name="${t.name}"><i data-lucide="Plus" class="w-4 h-4 pointer-events-none"></i></button><button class="delete-teacher-btn p-1 text-red-500 hover:bg-red-100 rounded-full" data-id="${d.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></td></tr>`;
                      }).join('')}</tbody></table>`;
                      lucide.createIcons();
                 });
            };
            
            // Listen for changes to render the manage teachers table
            const unsubTeachersList = onSnapshot(query(collection(db, 'teachers'), orderBy('name')), renderManageTeachersTable);

            const unsubStudentsList = onSnapshot(query(collection(db, 'students')), snap => {
                 const studentsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                 studentsData.sort((a, b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name));
                 state.allStudents = studentsData;
                 state.allClasses = [...new Set(state.allStudents.map(s => s.class))].sort();
                 populateSelect('student-class-filter', state.allClasses);
                 populateSelect('admin-attendance-class', state.allClasses);
                 populateSelect('admin-marks-class', state.allClasses);
                 populateSelect('exam-class', state.allClasses);
                 populateSelect('attendance-sheet-class', state.allClasses);
                 populateSelect('marks-class-select', state.allClasses);
                 populateSelect('calendar-class-select', state.allClasses);
                 const cont = document.getElementById('student-list-container');
                 if(cont) cont.innerHTML = `<table class="w-full text-sm"><thead class="bg-slate-50 text-left"><tr><th class="p-2">Name</th><th class="p-2">Class</th><th class="p-2 text-center">Actions</th></tr></thead><tbody>${state.allStudents.map(s => `<tr class="border-b border-slate-200"><td class="p-2 font-medium">${s.name}</td><td class="p-2">${s.class}</td><td class="p-2 text-center"><button class="edit-student-btn p-1 text-blue-500" data-id="${s.id}"><i data-lucide="Edit" class="w-4 h-4 pointer-events-none"></i></button><button class="delete-student-btn p-1 text-red-500 hover:bg-red-100 rounded-full" data-id="${s.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button></td></tr>`).join('')}</tbody></table>` || '<p class="text-slate-500">No students found.</p>';
                 lucide.createIcons();
            });
            const unsubRequestsAdmin = onSnapshot(query(collection(db, 'requests'), orderBy('timestamp', 'desc')), snap => {
                const cont = document.getElementById('admin-requests-list');
                if(!cont) return;
                if(snap.empty){ cont.innerHTML = '<p class="text-slate-500">No requests found.</p>'; return; }
                const statusColors = { pending: 'bg-amber-100 text-amber-800', approved: 'bg-green-100 text-green-800', denied: 'bg-red-100 text-red-800' };
                cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    return `<div class="p-3 rounded-md bg-slate-50"><div class="flex justify-between items-start"><div><h3 class="font-semibold">${r.title}</h3><p class="text-sm text-slate-600">From: ${r.teacherName}</p><p class="text-sm text-slate-500">${r.content}</p></div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors[r.status]}">${r.status}</span></div><p class="text-xs text-slate-400 text-right mt-1">${formatDate(r.timestamp)}</p>${r.status === 'pending' ? `<div class="flex gap-2 mt-2 border-t border-slate-200 pt-2"><button class="approve-request-btn text-sm bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" data-id="${d.id}">Approve</button><button class="deny-request-btn text-sm bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${d.id}">Deny</button></div>` : ''}</div>`
                }).join('');
            });
            const unsubExamRequests = onSnapshot(query(collection(db, 'exam-requests'), where('status', '==', 'pending'), orderBy('createdAt', 'desc')), snap => {
                const cont = document.getElementById('admin-exam-requests-list');
                if (!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">No pending exam requests.</p>'; return; }
                cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    return `<div class="p-3 rounded-md bg-slate-50 border">
                        <p class="font-semibold">${r.className} - ${r.subject}</p>
                        <p class="text-sm text-slate-600">Date: ${formatDate(r.date)}</p>
                        ${r.portions ? `<p class="text-sm text-slate-500 mt-1">Portions: ${r.portions}</p>` : ''}
                        <p class="text-xs text-slate-400 mt-2">Requested by: ${r.teacherName}</p>
                        <div class="flex gap-2 mt-2 border-t pt-2">
                            <button class="approve-exam-request-btn text-sm bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded" data-id="${d.id}">Approve</button>
                            <button class="deny-exam-request-btn text-sm bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${d.id}">Deny</button>
                        </div>
                    </div>`;
                }).join('');
            });
            const unsubScheduledExams = onSnapshot(query(collection(db, 'exams'), orderBy('date', 'desc')), snap => {
                const cont = document.getElementById('admin-scheduled-exams-list');
                if (!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">No exams scheduled.</p>'; return; }
                cont.innerHTML = snap.docs.map(d => {
                    const exam = d.data();
                    return `<div class="p-3 rounded-md bg-blue-50 border border-blue-200 flex justify-between items-start">
                        <div>
                            <p class="font-semibold">${exam.className} - ${exam.subject}</p>
                            <p class="text-sm text-slate-600">Date: ${formatDate(exam.date)}</p>
                            ${exam.portions ? `<p class="text-sm text-slate-500 mt-1">Portions: ${exam.portions}</p>` : ''}
                            <p class="text-xs text-slate-400 mt-2">Scheduled by: ${exam.scheduledBy}</p>
                        </div>
                        <button class="delete-exam-btn p-1 text-red-500 hover:bg-red-100 rounded-full" data-id="${d.id}"><i data-lucide="Trash2" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>`;
                }).join('');
                lucide.createIcons();
            });

            const unsubChat = onSnapshot(query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50)), snap => {
                const cont = document.getElementById('admin-chat-messages');
                if(!cont) return;
                cont.innerHTML = snap.docs.reverse().map(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === state.currentUser.uid;
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white' : 'bg-slate-200'}"><p class="text-sm">${msg.text}</p><p class="text-xs opacity-70 mt-1 text-right">${msg.senderEmail.split('@')[0]} at ${formatTime(msg.timestamp)}</p></div></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            });
            state.unsubscribeListeners.push(unsubT, unsubS, unsubN, unsubR, unsubNoticesList, unsubTeachersList, unsubStudentsList, unsubRequestsAdmin, unsubChat, unsubStatuses, unsubExamRequests, unsubScheduledExams);
        };
        const setupTeacherLiveStats = () => {
            const card = document.getElementById('teacher-attendance-recap-card');
            const listEl = document.getElementById('teacher-attendance-recap-list');
            if (!card || !listEl) return;

            card.classList.remove('hidden');

            const checkTimeAndRefresh = () => {
                const now = new Date();
                const day = now.getDay(); // 0 = Sunday
                const hour = now.getHours();
                const minute = now.getMinutes();
                const currentTimeInMinutes = hour * 60 + minute;
                
                let isClassTime = false;

                if (day === 0) { // Sunday
                    // Assuming morning hours end before 5:30 PM
                    if (currentTimeInMinutes < (17 * 60 + 30)) {
                        isClassTime = true;
                    }
                } else { // Monday to Saturday
                    const startTimeInMinutes = 17 * 60 + 30; // 5:30 PM
                    const endTimeInMinutes = 20 * 60 + 30;   // 8:30 PM
                    if (currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes) {
                        isClassTime = true;
                    }
                }

                if (!isClassTime) {
                    listEl.innerHTML = `<p class="text-slate-500 text-sm sm:col-span-3">Classes are not currently in session.</p>`;
                    return true; // Session is over/not started
                }
                
                return false; // Session is active
            };

            if (checkTimeAndRefresh()) {
                // Set a timer to check again tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                const timeToTomorrow = tomorrow.getTime() - Date.now();
                setTimeout(setupTeacherLiveStats, timeToTomorrow);
                return;
            }

            const todayStr = getTodayDateString();
            const attendanceQuery = query(
                collection(db, 'attendance'),
                where('teacherId', '==', state.currentUser.uid),
                where('date', '==', todayStr),
                orderBy('timestamp', 'desc')
            );

            const unsub = onSnapshot(attendanceQuery, (snap) => {
                if (checkTimeAndRefresh()) {
                    unsub(); // Stop listening if day is over
                    return;
                }

                if (snap.empty) {
                    listEl.innerHTML = `<p class="text-slate-500 text-sm sm:col-span-3">No classes taken yet today.</p>`;
                    return;
                }

                const records = snap.docs.map(d => d.data());
                
                const sessions = records.reduce((acc, record) => {
                    const key = `${record.class}|${record.subject}`;
                    if (!acc[key]) {
                        acc[key] = { present: 0, total: 0, className: record.class, subject: record.subject, timestamp: record.timestamp };
                    }
                    acc[key].total++;
                    if (record.status === 'present') acc[key].present++;
                    if (!acc[key].timestamp || record.timestamp.toMillis() > acc[key].timestamp.toMillis()) {
                       acc[key].timestamp = record.timestamp;
                    }
                    return acc;
                }, {});

                const lastThreeSessions = Object.values(sessions)
                    .sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis())
                    .slice(0, 3);

                if (lastThreeSessions.length === 0) {
                    listEl.innerHTML = `<p class="text-slate-500 text-sm sm:col-span-3">No classes taken yet today.</p>`;
                    return;
                }

                listEl.innerHTML = lastThreeSessions.map((session, index) => {
                    const canvasId = `teacher-recap-chart-${index}`;
                    return `<div class="text-center"><div class="w-full h-28 mx-auto"><canvas id="${canvasId}"></canvas></div></div>`;
                }).join('');

                lastThreeSessions.forEach((session, index) => {
                    const canvasId = `teacher-recap-chart-${index}`;
                    const title = `${session.className} - ${session.subject}`;
                    createAttendanceChart(canvasId, session.present, session.total, title);
                });
            });
            state.unsubscribeListeners.push(unsub);
        };


        const setupTeacherListeners = () => {
            setupTeacherLiveStats();
            const unsubTeacherData = onSnapshot(doc(db, 'teachers', state.currentUser.uid), docSnap => {
                if (docSnap.exists()) {
                    state.currentTeacherData = docSnap.data();
                    document.getElementById('teacher-welcome-name').textContent = state.currentTeacherData.name;
                    const classCountEl = document.getElementById('assigned-classes-count');
                    if (classCountEl) {
                        const startValue = parseInt(classCountEl.textContent.replace(/,/g, '')) || 0;
                        animateValue(classCountEl, startValue, state.currentTeacherData.assignedClasses.length, 1000);
                    }

                    const profilePicPreview = document.getElementById('profile-pic-preview');
                    const headerAvatar = document.getElementById('user-avatar');
                    const sidebarAvatarContainer = document.getElementById('sidebar-avatar-container');

                    if (state.currentTeacherData.photoURL) {
                        if (profilePicPreview) profilePicPreview.src = state.currentTeacherData.photoURL;
                        if (headerAvatar) headerAvatar.innerHTML = `<img src="${state.currentTeacherData.photoURL}" class="w-full h-full rounded-full object-cover">`;
                        if (sidebarAvatarContainer) sidebarAvatarContainer.innerHTML = `<img src="${state.currentTeacherData.photoURL}" class="w-10 h-10 rounded-full object-cover">`;
                    } else {
                        const userInitial = state.currentUser.email.charAt(0).toUpperCase();
                         if (profilePicPreview) profilePicPreview.src = `https://placehold.co/80x80/e0e7ff/4f46e5?text=${userInitial}`;
                         if (headerAvatar) headerAvatar.innerHTML = userInitial;
                         if (sidebarAvatarContainer) sidebarAvatarContainer.innerHTML = `<div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white">${userInitial}</div>`;
                    }
                    
                    populateSelect('teacher-attendance-class-subject', state.currentTeacherData.assignedClasses, c => `${c.class} - ${c.subject}`, c => `${c.class}|${c.subject}`);
                    
                    const uniqueClasses = [...new Set(state.currentTeacherData.assignedClasses.map(c => c.class))];
                    populateSelect('teacher-marks-class', uniqueClasses);
                    populateSelect('teacher-exam-class', uniqueClasses);
                    populateSelect('analytics-class-select', uniqueClasses);

                    const marksClassSelect = document.getElementById('teacher-marks-class');
                    if (marksClassSelect) {
                        marksClassSelect.addEventListener('change', () => {
                            const selectedClass = marksClassSelect.value;
                            const subjectsForClass = state.currentTeacherData.assignedClasses
                                .filter(c => c.class === selectedClass)
                                .map(c => c.subject);
                            populateSelect('teacher-marks-subject', subjectsForClass);
                        });
                    }
                    const examClassSelect = document.getElementById('teacher-exam-class');
                     if(examClassSelect) {
                          examClassSelect.addEventListener('change', () => {
                              const selectedClass = examClassSelect.value;
                              const subjectsForClass = state.currentTeacherData.assignedClasses
                                  .filter(c => c.class === selectedClass)
                                  .map(c => c.subject);
                              populateSelect('teacher-exam-subject', subjectsForClass);
                          });
                     }
                }
            });
            
            const unsubRequests = onSnapshot(query(collection(db, 'requests'), where('teacherId', '==', state.currentUser.uid), orderBy('timestamp', 'desc')), snap => {
                 const cont = document.getElementById('teacher-requests-list');
                if(!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">You have not submitted any requests.</p>'; return; }
                 cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    const statusColors = { pending: 'bg-amber-100 text-amber-800', approved: 'bg-green-100 text-green-800', denied: 'bg-red-100 text-red-800' };
                    return `<div class="p-3 rounded-md bg-slate-50"><div class="flex justify-between items-start"><div><h3 class="font-semibold">${r.title}</h3><p class="text-sm text-slate-500">${r.content}</p></div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors[r.status]}">${r.status}</span></div><p class="text-xs text-slate-400 text-right mt-1">${formatDate(r.timestamp)}</p></div>`;
                }).join('');
            });
             const unsubMyExamRequests = onSnapshot(query(collection(db, 'exam-requests'), where('teacherId', '==', state.currentUser.uid), orderBy('createdAt', 'desc')), snap => {
                const cont = document.getElementById('teacher-exam-requests-list');
                if(!cont) return;
                if (snap.empty) { cont.innerHTML = '<p class="text-slate-500">You have not requested any exams.</p>'; return; }
                const statusColors = { pending: 'bg-amber-100 text-amber-800', approved: 'bg-green-100 text-green-800', denied: 'bg-red-100 text-red-800' };
                cont.innerHTML = snap.docs.map(d => {
                    const r = d.data();
                    return `<div class="p-3 rounded-md bg-slate-50 border">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold">${r.className} - ${r.subject}</p>
                                <p class="text-sm text-slate-600">Date: ${formatDate(r.date)}</p>
                            </div>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColors[r.status]}">${r.status}</span>
                        </div>
                        ${r.portions ? `<p class="text-sm text-slate-500 mt-1">Portions: ${r.portions}</p>` : ''}
                    </div>`;
                }).join('');
            });

            const unsubChat = onSnapshot(query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50)), snap => {
                const cont = document.getElementById('teacher-chat-messages');
                if(!cont) return;
                cont.innerHTML = snap.docs.reverse().map(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === state.currentUser.uid;
                    return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white' : 'bg-slate-200'}"><p class="text-sm">${msg.text}</p><p class="text-xs opacity-70 mt-1 text-right">${msg.senderEmail.split('@')[0]} at ${formatTime(msg.timestamp)}</p></div></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            });

             const handleBeforeUnload = (e) => {
                if (state.currentUser && state.userRole === 'teacher') {
                    setDoc(doc(db, 'status', state.currentUser.uid), {
                        state: 'offline',
                        last_changed: serverTimestamp()
                    }, { merge: true });
                }
            };
            window.addEventListener('beforeunload', handleBeforeUnload);

            state.unsubscribeListeners.push(unsubTeacherData, unsubRequests, unsubChat, unsubMyExamRequests, () => {
                window.removeEventListener('beforeunload', handleBeforeUnload);
            });
        };
        
        // ===================================================================
        // ========================= UI INITIALIZATION =======================
        // ===================================================================
        
        const initializeAppUI = (role) => {
            renderSidebar(role);
            if (role === 'admin') {
                renderAdminDashboardSections();
                showPage('admin-dashboard');
                navigateToSection('admin-overview', 'Admin Overview');
                setupAdminListeners();
            } else if (role === 'teacher') {
                renderTeacherDashboardSections();
                showPage('teacher-dashboard');
                navigateToSection('teacher-overview', 'Teacher Overview');
                setupTeacherListeners();
            }
            attachDashboardEventListeners();
            lucide.createIcons();
            startClock();
            
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach((link, index) => {
                link.style.animationDelay = `${index * 0.05}s`;
                link.classList.add('sidebar-link-animated');
            });
        };

        const initializeStudentPortal = async () => {
            startClock();
            // Animate cards
            document.querySelectorAll('#student-portal .card, #student-stats-grid .card').forEach((card, index) => {
                card.classList.add('fade-in');
                card.style.animationDelay = `${index * 0.07}s`;
            });

            // Animate stats
            const studentCountQuery = await getDocs(collection(db, 'students'));
            const teacherCountQuery = await getDocs(collection(db, 'teachers'));
            
            animateValue(document.getElementById('portal-student-count'), 0, studentCountQuery.size, 1500);
            animateValue(document.getElementById('portal-teacher-count'), 0, teacherCountQuery.size, 1500);

            const allSubjects = new Set();
            teacherCountQuery.forEach(doc => {
                const teacher = doc.data();
                if (teacher.assignedClasses) {
                    teacher.assignedClasses.forEach(c => allSubjects.add(c.subject.toLowerCase()));
                }
            });
             animateValue(document.getElementById('portal-subject-count'), 0, allSubjects.size, 1500);


            const noticesQuery = query(collection(db, 'notices'), orderBy('timestamp', 'desc'));
            const unsubNotices = onSnapshot(noticesQuery, (snapshot) => {
                const container = document.getElementById('student-notices-list');
                if(!container) return;
                if (snapshot.empty) { container.innerHTML = `<p class="text-slate-500">No notices available at the moment.</p>`; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const notice = doc.data();
                    return `<div class="p-4 rounded-lg bg-slate-50 border border-slate-200"><h3 class="font-bold text-md">${notice.title}</h3><p class="text-sm text-slate-600 mt-1">${notice.content}</p><p class="text-xs text-slate-400 mt-2 text-right">Posted on: ${formatDate(notice.timestamp)}</p></div>`;
                }).join('');
            });
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today

            const examsQuery = query(collection(db, 'exams'), where('date', '>=', Timestamp.fromDate(today)), orderBy('date'));
            const unsubExams = onSnapshot(examsQuery, (snapshot) => {
                const container = document.getElementById('student-exams-list');
                if (!container) return;
                if (snapshot.empty) { container.innerHTML = `<p class="text-slate-500">No upcoming exams scheduled.</p>`; return; }
                container.innerHTML = snapshot.docs.map(doc => {
                    const exam = doc.data();
                    return `<div class="p-3 rounded-md bg-amber-50 border border-amber-200">
                        <p class="font-semibold">${exam.className} - ${exam.subject}</p>
                        <p class="text-sm text-slate-600 font-medium">${formatDate(exam.date)}</p>
                        ${exam.portions ? `<p class="text-xs text-slate-500 mt-1">${exam.portions}</p>` : ''}
                    </div>`;
                }).join('');
            });
            
            const todayStr = getTodayDateString();
            const absenteesQuery = query(collection(db, 'attendance'), where('date', '==', todayStr), where('status', '==', 'absent'));
            
            let absenteeDataForModal = []; // Store data for modal
            
            const unsubAbsentees = onSnapshot(absenteesQuery, (snapshot) => {
                const countEl = document.getElementById('absentee-count');
                if(!countEl) return;
                const startValue = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
                animateValue(countEl, startValue, snapshot.size, 1000);

                absenteeDataForModal = snapshot.docs.map(doc => doc.data())
                    .sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis());
            });

            document.getElementById('absentee-card')?.addEventListener('click', () => {
                let contentHTML = '<p class="text-slate-500">No absentees reported for today yet.</p>';
                if(absenteeDataForModal.length > 0) {
                     contentHTML = `<div class="max-h-[60vh] overflow-y-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100"><tr><th class="p-2">Student Name</th><th class="p-2">Class</th><th class="p-2">Subject</th><th class="p-2">Marked By</th></tr></thead><tbody>${absenteeDataForModal.map(a => `<tr class="border-b border-slate-200"><td class="p-2">${a.studentName}</td><td class="p-2">${a.class}</td><td class="p-2">${a.subject}</td><td class="p-2">${a.teacherName}</td></tr>`).join('')}</tbody></table></div>`;
                }
                 showModal("Today's Absentee List", contentHTML, `<button id="cancel-delete" class="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200">Close</button>`);
            });
            
            const marksQuery = query(collection(db, 'marks'));
            const unsubMarks = onSnapshot(marksQuery, (snapshot) => {
                const display = document.getElementById('student-marks-display');
                if (!display) return;
                if (snapshot.empty) {
                    display.innerHTML = `<p class="text-slate-500">No marks have been published yet.</p>`;
                    return;
                }

                const marksData = snapshot.docs.map(d => d.data());
                
                const marksByClass = marksData.reduce((acc, mark) => {
                    const className = mark.class;
                    const testName = mark.testName || 'Unnamed Test';
                    const subject = mark.subject || 'General';

                    if (!acc[className]) acc[className] = {};
                    if (!acc[className][testName]) acc[className][testName] = {};
                    if (!acc[className][testName][subject]) {
                        acc[className][testName][subject] = { maxMarks: mark.maxMarks, marks: [] };
                    }
                    acc[className][testName][subject].marks.push(mark);
                    return acc;
                }, {});
                
                display.innerHTML = Object.entries(marksByClass).map(([className, tests]) => {
                    return `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 p-3 bg-indigo-50 rounded-lg sticky top-0">${className}</h2>
                        ${Object.entries(tests).map(([testName, subjects]) => `
                            <div class="mb-8 ml-4">
                                <h3 class="text-xl font-semibold mb-4 p-2 bg-slate-100 rounded-md">${testName}</h3>
                                ${Object.entries(subjects).map(([subject, data]) => `
                                    <div class="mb-6 ml-4">
                                        <h4 class="font-bold text-lg mb-2">${subject} (Out of ${data.maxMarks || 'N/A'})</h4>
                                        <table class="w-full text-sm">
                                            <thead class="bg-slate-50">
                                                <tr><th class="p-2 text-left">Student Name</th><th class="p-2 text-left">Marks Obtained</th></tr>
                                            </thead>
                                            <tbody>
                                                ${data.marks.sort((a,b) => a.studentName.localeCompare(b.studentName)).map(m => `
                                                    <tr class="border-b border-slate-200">
                                                        <td class="p-2 font-medium">${m.studentName}</td>
                                                        <td class="p-2">${m.marks}</td>
                                                    </tr>`).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>`;
                }).join('');
            });

            state.unsubscribeListeners.push(unsubNotices, unsubAbsentees, unsubMarks, unsubExams);
        };
        
        // ===================================================================
        // ========================= EVENT LISTENERS =========================
        // ===================================================================

        const uploadProfilePicture = async () => {
            const fileInput = document.getElementById('profile-pic-input');
            const file = fileInput.files[0];
            if (!file) {
                showToast('Please select an image first.', 'info');
                return;
            }

            if (!state.currentUser) {
                showToast('You must be logged in to upload a picture.', 'error');
                return;
            }

            showLoading();
            try {
                const storageRef = ref(storage, `profile-pictures/${state.currentUser.uid}/${file.name}`);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                await updateDoc(doc(db, 'teachers', state.currentUser.uid), {
                    photoURL: downloadURL
                });

                document.getElementById('upload-progress-container').classList.add('hidden');
                fileInput.value = ''; // Clear the input
                showToast('Profile picture updated successfully!', 'success');
            } catch (error) {
                console.error("Error uploading profile picture:", error);
                showToast('Failed to upload profile picture.', 'error');
            } finally {
                hideLoading();
            }
        };

        const attachAdminCalendarListeners = () => {
            const dashboard = DOMElements.adminDashboard;
            if (!dashboard) return;

            // --- Holiday Calendar Listeners ---
            dashboard.addEventListener('click', async e => {
                const target = e.target;
                if (target.closest('#prev-holiday-month')) {
                    calendarState.holiday.month--;
                    if (calendarState.holiday.month < 0) {
                        calendarState.holiday.month = 11;
                        calendarState.holiday.year--;
                    }
                    renderHolidayCalendar(calendarState.holiday.year, calendarState.holiday.month);
                }
                if (target.closest('#next-holiday-month')) {
                    calendarState.holiday.month++;
                    if (calendarState.holiday.month > 11) {
                        calendarState.holiday.month = 0;
                        calendarState.holiday.year++;
                    }
                    renderHolidayCalendar(calendarState.holiday.year, calendarState.holiday.month);
                }
                const dateCell = target.closest('[data-date]');
                if (dateCell) {
                    const dateStr = dateCell.dataset.date;
                    const isHoliday = calendarState.holidays.has(dateStr);
                    showLoading();
                    try {
                        if (isHoliday) {
                            await deleteDoc(doc(db, 'holidays', dateStr));
                            showToast('Holiday removed.', 'success');
                        } else {
                            await setDoc(doc(db, 'holidays', dateStr), { date: dateStr, createdAt: serverTimestamp() });
                            showToast('Holiday added.', 'success');
                        }
                        await renderHolidayCalendar(calendarState.holiday.year, calendarState.holiday.month);
                    } catch (err) {
                        console.error("Error updating holiday: ", err);
                        showToast('Could not update holiday.', 'error');
                    } finally {
                        hideLoading();
                    }
                }
            });

            // --- Student Attendance Calendar Listeners ---
            const classSelect = document.getElementById('calendar-class-select');
            const studentSelect = document.getElementById('calendar-student-select');

            classSelect?.addEventListener('change', () => {
                const selectedClass = classSelect.value;
                studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                if (selectedClass) {
                    const studentsInClass = state.allStudents.filter(s => s.class === selectedClass);
                    populateSelect('calendar-student-select', studentsInClass, 'name', 'id');
                    studentSelect.disabled = false;
                } else {
                    studentSelect.disabled = true;
                }
                document.getElementById('student-attendance-calendar-container').innerHTML = `<p class="text-slate-500">Please select a student to view their attendance calendar.</p>`;
            });

            studentSelect?.addEventListener('change', () => {
                const studentId = studentSelect.value;
                if (studentId) {
                    // Reset to current month on new student selection
                    calendarState.student.year = new Date().getFullYear();
                    calendarState.student.month = new Date().getMonth();
                    renderStudentAttendanceCalendar(studentId, calendarState.student.year, calendarState.student.month);
                }
            });
            
            dashboard.addEventListener('click', e => {
                const studentId = studentSelect?.value;
                if (!studentId) return;

                if (e.target.closest('#prev-student-month')) {
                    calendarState.student.month--;
                    if (calendarState.student.month < 0) {
                        calendarState.student.month = 11;
                        calendarState.student.year--;
                    }
                    renderStudentAttendanceCalendar(studentId, calendarState.student.year, calendarState.student.month);
                }
                if (e.target.closest('#next-student-month')) {
                    calendarState.student.month++;
                    if (calendarState.student.month > 11) {
                        calendarState.student.month = 0;
                        calendarState.student.year++;
                    }
                    renderStudentAttendanceCalendar(studentId, calendarState.student.year, calendarState.student.month);
                }
            });
        };

        const attachAppEventListeners = () => {
            const app = document.getElementById('app');

            app.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formId = e.target.id;
                
                // --- Login Form Submissions ---
                if (formId === 'admin-login-form') {
                    handleLogin(document.getElementById('admin-email').value, document.getElementById('admin-password').value, 'admin');
                    return;
                }
                if (formId === 'teacher-login-form') {
                    handleLogin(document.getElementById('teacher-email').value, document.getElementById('teacher-password').value, 'teacher');
                    return;
                }

                // --- Other Form Submissions ---
                let collectionName, docData;
                
                if (formId === 'add-teacher-form') addTeacher(e.target.querySelector('#new-teacher-name').value, e.target.querySelector('#new-teacher-email').value, e.target.querySelector('#new-teacher-password').value);
                if (formId === 'add-student-form') addStudent(document.getElementById('new-student-name').value, document.getElementById('new-student-class').value);
                if (formId === 'schedule-exam-form') {
                    const className = document.getElementById('exam-class').value;
                    const subject = document.getElementById('exam-subject').value;
                    const dateStr = document.getElementById('exam-date').value;
                    const portions = document.getElementById('exam-portions').value;
                    if(!className || !subject || !dateStr) { showToast('Please fill all required fields.', 'error'); return; }
                    const examDate = new Date(dateStr);
                    collectionName = 'exams';
                    docData = { className, subject, date: Timestamp.fromDate(examDate), portions, scheduledBy: 'Admin', createdAt: serverTimestamp() };
                }

                if (formId === 'request-exam-form') {
                    const className = document.getElementById('teacher-exam-class').value;
                    const subject = document.getElementById('teacher-exam-subject').value;
                    const dateStr = document.getElementById('teacher-exam-date').value;
                    const portions = document.getElementById('teacher-exam-portions').value;
                    if(!className || !subject || !dateStr) { showToast('Please fill all required fields.', 'error'); return; }
                    const examDate = new Date(dateStr);
                    collectionName = 'exam-requests';
                    docData = {
                        className, subject, date: Timestamp.fromDate(examDate), portions,
                        teacherId: state.currentUser.uid, teacherName: state.currentTeacherData.name,
                        status: 'pending', createdAt: serverTimestamp()
                    };
                }

                if (formId === 'add-notice-form') { collectionName = 'notices'; docData = { title: e.target.querySelector('#notice-title').value, content: e.target.querySelector('#notice-content').value, timestamp: serverTimestamp() }; }
                if (formId === 'add-request-form') { collectionName = 'requests'; docData = { title: e.target.querySelector('#request-title').value, content: e.target.querySelector('#request-content').value, teacherId: state.currentUser.uid, teacherName: state.currentTeacherData.name, status: 'pending', timestamp: serverTimestamp() }; }
                if (formId.includes('-chat-form')) { 
                    collectionName = 'chat'; 
                    const input = e.target.querySelector('input');
                    docData = { text: input.value, senderId: state.currentUser.uid, senderEmail: state.currentUser.email, role: state.userRole, timestamp: serverTimestamp() };
                    if (docData.text) input.value = ''; else return;
                }
                if (formId === 'change-password-form') {
                    const currentPass = document.getElementById('current-password').value;
                    const newPass = document.getElementById('new-password').value;
                    const confirmPass = document.getElementById('confirm-new-password').value;
                    if (newPass !== confirmPass) {
                        showToast("New passwords do not match.", "error"); return;
                    }
                    if (newPass.length < 6) {
                        showToast("Password should be at least 6 characters long.", "error"); return;
                    }
                    
                    showLoading();
                    try {
                        const user = auth.currentUser;
                        const credential = EmailAuthProvider.credential(user.email, currentPass);
                        await reauthenticateWithCredential(user, credential);
                        await updatePassword(user, newPass);
                        showToast("Password updated successfully!", "success");
                        e.target.reset();
                    } catch(error) {
                         showToast("Failed to update password. Check your current password.", "error");
                         console.error(error);
                    } finally {
                        hideLoading();
                    }
                    return; // prevent further processing
                }

                if(collectionName) {
                    await addDoc(collection(db, collectionName), docData);
                    showToast('Success!', 'success');
                    if(!formId.includes('-chat-form')) e.target.reset();
                }
            });

            app.addEventListener('click', async (e) => {
                const target = e.target;

                // --- Page Navigation & Login Form Toggles ---
                if (target.closest('#go-to-login')) {
                    e.preventDefault();
                    cleanupListeners();
                    showPage('login-page');
                    return;
                }
                if (target.closest('#go-to-student-portal')) {
                    e.preventDefault();
                    cleanupListeners();
                    showPage('student-portal');
                    initializeStudentPortal();
                    return;
                }
                 const adminBtn = document.getElementById('admin-login-btn');
                 const teacherBtn = document.getElementById('teacher-login-btn');
                 const adminForm = document.getElementById('admin-login-form');
                 const teacherForm = document.getElementById('teacher-login-form');
                if (target.closest('#admin-login-btn')) {
                    adminBtn.classList.add('active', 'bg-indigo-600', 'text-white');
                    adminBtn.classList.remove('bg-slate-200', 'text-slate-600');
                    teacherBtn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    teacherBtn.classList.add('bg-slate-200', 'text-slate-600');
                    adminForm.classList.remove('hidden');
                    teacherForm.classList.add('hidden');
                    return;
                }
                if (target.closest('#teacher-login-btn')) {
                    teacherBtn.classList.add('active', 'bg-indigo-600', 'text-white');
                    teacherBtn.classList.remove('bg-slate-200', 'text-slate-600');
                    adminBtn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    adminBtn.classList.add('bg-slate-200', 'text-slate-600');
                    teacherForm.classList.remove('hidden');
                    adminForm.classList.add('hidden');
                    return;
                }

                // Universal logout button check
                if (target.closest('#header-logout-btn')) {
                    handleLogout();
                    return;
                }
                if (target.closest('#view-assigned-classes-card')) {
                    showAssignedClassesModal();
                }

                if (target.closest('#total-teachers-card')) {
                    showTeacherStatusModal();
                }

                if (target.closest('#total-students-card')) {
                    showStudentListModal();
                }

                // Admin buttons
                if (target.closest('.delete-exam-btn')) deleteDoc(doc(db, 'exams', target.closest('.delete-exam-btn').dataset.id));
                if (target.classList.contains('approve-exam-request-btn')) {
                    const requestId = target.dataset.id;
                    const requestRef = doc(db, 'exam-requests', requestId);
                    showLoading();
                    try {
                        const requestSnap = await getDoc(requestRef);
                        if (requestSnap.exists()) {
                            const requestData = requestSnap.data();
                            await addDoc(collection(db, 'exams'), {
                                className: requestData.className,
                                subject: requestData.subject,
                                date: requestData.date,
                                portions: requestData.portions,
                                scheduledBy: requestData.teacherName,
                                createdAt: serverTimestamp()
                            });
                            await updateDoc(requestRef, { status: 'approved' });
                            showToast('Exam request approved and scheduled!', 'success');
                        }
                    } catch(e) { console.error(e); showToast('Failed to approve request.', 'error'); }
                    finally { hideLoading(); }
                }

                if (target.classList.contains('deny-exam-request-btn')) {
                    updateDoc(doc(db, 'exam-requests', target.dataset.id), { status: 'denied' });
                }

                if (target.classList.contains('delete-notice-btn')) deleteDoc(doc(db, 'notices', target.dataset.id));
                if (target.closest('.delete-teacher-btn')) deleteTeacher(target.closest('.delete-teacher-btn').dataset.id);
                if (target.closest('.edit-student-btn')) showEditStudentModal(target.closest('.edit-student-btn').dataset.id);
                if (target.closest('.delete-student-btn')) deleteStudent(target.closest('.delete-student-btn').dataset.id);
                if (target.closest('.edit-teacher-btn')) showEditTeacherModal(target.closest('.edit-teacher-btn').dataset.id);

                if (target.classList.contains('approve-request-btn')) updateDoc(doc(db, 'requests', target.dataset.id), { status: 'approved' });
                if (target.classList.contains('deny-request-btn')) updateDoc(doc(db, 'requests', target.dataset.id), { status: 'denied' });
                if (target.classList.contains('assign-class-btn')) {
                    const teacherId = target.dataset.id, teacherName = target.dataset.name;
                    showModal(`Assign Class to ${teacherName}`, 
                        `<div class="space-y-4"><input type="text" id="assign-class-name" placeholder="Class Name (e.g., 10th A)" class="input-field"><input type="text" id="assign-subject-name" placeholder="Subject Name (e.g., Mathematics)" class="input-field"></div>`, 
                        `<button id="cancel-delete" class="px-4 py-2 rounded-md hover:bg-slate-100">Cancel</button><button id="confirm-assign-btn" class="btn-primary ripple">Assign</button>`);
                    document.getElementById('confirm-assign-btn').onclick = async () => {
                        const className = document.getElementById('assign-class-name').value, subjectName = document.getElementById('assign-subject-name').value;
                        if (!className || !subjectName) { showToast('All fields required.', 'error'); return; }
                        const teacherRef = doc(db, 'teachers', teacherId);
                        const teacherSnap = await getDoc(teacherRef);
                        if(teacherSnap.exists()){
                            await updateDoc(teacherRef, { assignedClasses: [...teacherSnap.data().assignedClasses || [], { class: className, subject: subjectName }] });
                            showToast('Class assigned!', 'success');
                            closeModal();
                        }
                    };
                }
                 if(target.id === 'admin-view-marks-btn') {
                     const className = document.getElementById('admin-marks-class').value;
                     if (!className) { showToast('Please select a class.', 'error'); return; }
                     viewAdminMarks(className);
                 }
                if(target.id === 'admin-view-attendance-btn') {
                    const date = document.getElementById('admin-attendance-date').value;
                    const className = document.getElementById('admin-attendance-class').value;
                    const subject = document.getElementById('admin-attendance-subject').value;
                    if (!date || !className) { 
                        showToast('Please select a date and class.', 'error'); 
                        return; 
                    }
                    viewAdminAttendanceRecords(date, className, subject.trim());
                }
                 if (target.id === 'custom-attendance-toggle') {
                    document.getElementById('custom-attendance-details').classList.toggle('hidden');
                }

                // Teacher buttons
                if (target.id === 'teacher-load-students-btn') {
                    const sel = document.getElementById('teacher-attendance-class-subject');
                    const date = document.getElementById('teacher-attendance-date').value;
                    if (!sel.value || !date) { showToast('Please select all fields.', 'error'); return; }
                    const [className, subject] = sel.value.split('|');
                    loadAttendanceSheet(className, subject, date);
                }
                if (target.id === 'teacher-load-marks-sheet-btn') {
                    const testName = document.getElementById('teacher-marks-test-name').value;
                    const className = document.getElementById('teacher-marks-class').value;
                    const subject = document.getElementById('teacher-marks-subject').value;
                    const maxMarks = document.getElementById('teacher-marks-max').value;
                    if (!testName || !className || !subject || !maxMarks) { showToast('Please fill out all fields.', 'error'); return; }
                    if (Number(maxMarks) <= 0) { showToast('Maximum marks must be a positive number.', 'error'); return; }
                    loadMarksSheet(testName, className, subject, maxMarks);
                }
                if (target.id === 'save-attendance-btn') {
                    const [className, subject] = document.getElementById('teacher-attendance-class-subject').value.split('|');
                    const date = document.getElementById('teacher-attendance-date').value;
                    const rows = document.querySelectorAll('#attendance-tbody tr');
                    if (rows.length === 0) return;
                    showLoading();
                    let presentCount = 0;
                    try {
                        const batch = writeBatch(db);
                        rows.forEach(row => {
                            const studentId = row.dataset.studentId, studentName = row.dataset.studentName;
                            const status = row.querySelector(`input:checked`).value;
                            if (status === 'present') presentCount++;
                            const docId = `${date}_${className}_${subject}_${studentId}`.replace(/\s+/g, '_');
                            batch.set(doc(db, 'attendance', docId), { date, class: className, subject, studentId, studentName, status, teacherId: state.currentUser.uid, teacherName: state.currentTeacherData.name, timestamp: serverTimestamp() });
                        });
                        await batch.commit();
                        showToast('Attendance saved!', 'success');
                        
                        // Show animated confirmation modal
                        const title = `${className} - ${subject}`;
                        const content = `<div class="w-48 h-48 mx-auto"><canvas id="attendance-confirm-chart"></canvas></div>`;
                        const footer = `<button id="cancel-delete" class="btn-primary ripple">Close</button>`;
                        showModal('Attendance Saved!', content, footer);
                        createAttendanceChart('attendance-confirm-chart', presentCount, rows.length, title);

                    } catch (error) { showToast('Failed to save attendance.', 'error'); } 
                    finally { hideLoading(); }
                }
                if (target.id === 'save-marks-btn') {
                    const testName = document.getElementById('teacher-marks-test-name').value;
                    const className = document.getElementById('teacher-marks-class').value;
                    const subject = document.getElementById('teacher-marks-subject').value;
                    const maxMarks = Number(document.getElementById('teacher-marks-max').value);
                    const rows = document.querySelectorAll('#marks-tbody tr');
                    if (rows.length === 0) return;

                    let validationPassed = true;
                    rows.forEach(row => {
                        const marksInput = row.querySelector('input[type="number"]');
                        if (Number(marksInput.value) > maxMarks) {
                            marksInput.style.borderColor = 'red';
                            validationPassed = false;
                        } else {
                            marksInput.style.borderColor = '';
                        }
                    });

                    if (!validationPassed) {
                        showToast('One or more marks exceed the maximum value.', 'error');
                        return;
                    }

                    showLoading();
                    try {
                        const batch = writeBatch(db);
                        rows.forEach(row => {
                            const studentId = row.dataset.studentId;
                            const marks = row.querySelector('input[type="number"]').value;
                            if (marks !== '') {
                                const docId = `${testName}_${className}_${subject}_${studentId}`.replace(/\s+/g, '_');
                                batch.set(doc(db, 'marks', docId), { 
                                    testName: testName, 
                                    class: className, 
                                    subject: subject,
                                    maxMarks: maxMarks,
                                    studentId, 
                                    studentName: row.dataset.studentName, 
                                    marks: Number(marks), 
                                    teacherId: state.currentUser.uid, 
                                    teacherName: state.currentTeacherData.name, 
                                    timestamp: serverTimestamp() 
                                });
                            }
                        });
                        await batch.commit();
                        showToast('Marks saved!', 'success');
                    } catch (error) { 
                        console.error("Error saving marks: ", error);
                        showToast('Failed to save marks.', 'error'); 
                    } 
                    finally { hideLoading(); }
                }
                 if (target.id === 'upload-pic-btn') {
                    uploadProfilePicture();
                }
                // Student portal buttons
                 if (target.id === 'view-attendance-sheet-btn') {
                    showToast('This feature is under development.', 'info');
                }
            });
             // Add a single 'change' event listener for the whole app
            app.addEventListener('change', (e) => {
                if (e.target.id === 'profile-pic-input') {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('profile-pic-preview').src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                        document.getElementById('upload-progress-container').classList.remove('hidden');
                    }
                }
            });
        };
        
        const attachDashboardEventListeners = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                sidebar?.classList.add('open');
                overlay?.classList.remove('hidden');
            });
            
            document.getElementById('desktop-sidebar-toggle').addEventListener('click', () => {
                sidebar?.classList.toggle('collapsed');
                 document.querySelector('.main-content').classList.toggle('md:ml-[72px]', sidebar?.classList.contains('collapsed'));
                 document.querySelector('.main-content').classList.toggle('md:ml-[260px]', !sidebar?.classList.contains('collapsed'));

            });

            overlay?.addEventListener('click', () => {
                 sidebar?.classList.remove('open');
                 overlay.classList.add('hidden');
            });
            
            if (sidebar) {
                sidebar.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link');
                    if (link) {
                        e.preventDefault();
                        const targetId = link.dataset.target;
                        const title = link.querySelector('span').textContent;
                        navigateToSection(targetId, title);
                    }
                });
            }
        };
        
        // ===================================================================
        // ========================= APP INITIALIZATION ======================
        // ===================================================================
        
        const init = () => {
            lucide.createIcons();
            attachAppEventListeners(); 
            // onAuthStateChanged will handle showing the correct initial page after the auto-logout
            if (window.location.hash === '#login-page') showPage('login-page');
            else showPage('student-portal');
        };

        window.addEventListener('load', init);
    </script>

</body>
</html>





